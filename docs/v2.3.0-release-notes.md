# v2.3.0 보안 강화 + 버그 수정 + 성능 개선 (2026-02-13)

커밋: `5a7f149`, `c966a0f` | 수정 파일: 22개 (신규 2개)

---

## 1. 보안 강화 (10항목)

### HIGH

| #   | 항목                                                                                       | 파일                                                                                                          |
| --- | ------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------- |
| 1   | **httpOnly 쿠키 전환** — document.cookie → 서버 API 경유. XSS 토큰 탈취 차단               | middleware.ts, login.astro, AdminLayout.astro, api/auth/set-cookies.ts(신규), api/auth/clear-cookies.ts(신규) |
| 2   | **outsourced_config 노출 차단** — 가격 설정을 서버에서만 처리, 클라이언트 미노출           | calculate-price.ts, ProductView.jsx, product/[id].astro                                                       |
| 3   | **가격 검증 guidePriceTotal 누락** — 일반상품 가이드 블록 가격이 서버 검증에서 빠지던 버그 | create-order.ts, Checkout.jsx                                                                                 |
| 4   | **에러 응답 가격 정보 노출 제거**                                                          | create-order.ts                                                                                               |

### MEDIUM

| #   | 항목                                                      | 파일              |
| --- | --------------------------------------------------------- | ----------------- |
| 5   | **upload.ts 인증 강화** — getUser() 실제 토큰 검증        | upload.ts         |
| 6   | **products API 인증** — ?all=1에 getUser() 검증 추가      | products/index.ts |
| 7   | **검색 SQL Injection 방지** — %, \_ 와일드카드 새니타이징 | orderService.ts   |
| 8   | **sortBy 컬럼 화이트리스트**                              | orderService.ts   |
| 9   | **upload MIME 빈값 처리 개선**                            | upload.ts         |

### LOW

| #   | 항목                                                 | 파일                                          |
| --- | ---------------------------------------------------- | --------------------------------------------- |
| 10  | **테이블명 불일치** site_config → site_settings 통일 | siteConfigService.ts, LandingSectionsForm.tsx |

---

## 2. 버그 수정 (4항목)

| #   | 항목                                                                                                            | 파일                                |
| --- | --------------------------------------------------------------------------------------------------------------- | ----------------------------------- |
| 11  | **주문번호 충돌 재시도** — 최대 5회 (error 23505 감지)                                                          | orderService.ts                     |
| 12  | **상태 카운트 1000행 제한** — count:exact, head:true 병렬 쿼리                                                  | orderService.ts                     |
| 13  | **designCover useEffect 의존성 누락** — 디자인 비용 미반영                                                      | ProductView.jsx                     |
| 14  | **outsourced 가격 API 404** — outsourced_config가 content JSONB 안의 프로퍼티인데 컬럼으로 select해서 쿼리 실패 | calculate-price.ts, create-order.ts |

---

## 3. 성능 개선 (3항목)

| #   | 항목                                        | 파일                            |
| --- | ------------------------------------------- | ------------------------------- |
| 15  | **홈페이지 CDN 캐시** s-maxage=3600         | index.astro                     |
| 16  | **다음 우편번호 async 로딩**                | checkout.astro                  |
| 17  | **DOMPurify 제거** (관리자 컨텐츠에 불필요) | ProductView.jsx, CoverModal.jsx |

---

## 4. 신규 파일

| 파일                                  | 역할                               |
| ------------------------------------- | ---------------------------------- |
| `src/pages/api/auth/set-cookies.ts`   | httpOnly 쿠키 설정 서버 엔드포인트 |
| `src/pages/api/auth/clear-cookies.ts` | 쿠키 삭제 서버 엔드포인트          |

---

## 5. 검증 결과

- 보안 에이전트 검증: **14/14 PASS**
- httpOnly 쿠키 플로우 검증: **5/5 PASS**
- document.cookie 코드베이스 전체 검색: **0건** (완전 제거)
- outsourced 가격 API 테스트: **200 OK** (165,000원 / 30부 100페이지)
- 빌드: **통과**

---

## 6. 향후 작업

| 항목                    | 설명                                                                   |
| ----------------------- | ---------------------------------------------------------------------- |
| CJK 폰트 서브셋팅       | 3.2MB → ~400KB, fonttools 외부 도구 필요                               |
| API Rate Limiting       | 엔드포인트 요청 제한 미적용                                            |
| dangerouslySetInnerHTML | DOMPurify 제거 후 관리자 HTML 직접 렌더링 (관리자만 편집하므로 저위험) |

---

## 수정 파일 전체 목록 (22개)

```
CHANGELOG.md
CLAUDE.md
src/components/admin/LandingSectionsForm.tsx
src/components/edu100/CoverModal.jsx
src/components/order/Checkout.jsx
src/components/product/ProductView.jsx
src/layouts/AdminLayout.astro
src/lib/orderService.ts
src/lib/siteConfigService.ts
src/middleware.ts
src/pages/admin/login.astro
src/pages/api/auth/set-cookies.ts (신규)
src/pages/api/auth/clear-cookies.ts (신규)
src/pages/api/calculate-price.ts
src/pages/api/create-order.ts
src/pages/api/products/index.ts
src/pages/api/upload.ts
src/pages/checkout.astro
src/pages/index.astro
src/pages/product/[id].astro
```
