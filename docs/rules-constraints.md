# 연동 기준 / 액션 제한 규칙

> 최종 업데이트: 2026-02-05
> 대상: sungjin-print100-nagi (v2)
> 코드: `src/data/rules.ts`

---

## 관련 파일

| 파일 | 역할 |
|------|------|
| `src/data/rules.ts` | 규칙 데이터 (코드 내 참조용) |
| `src/lib/priceEngine.ts` | 코팅 검증, 두께 검증 함수 |
| `src/components/admin/ProductBuilder/index.jsx` | 관리자 빌더 규칙 적용 |
| `src/components/product/ProductView.jsx` | 고객 페이지 규칙 적용 |

---

## 1. 적용 완료 규칙

### R001: 오시 강제 (접지 연동)

| 항목 | 내용 |
|------|------|
| **조건** | 용지 평량 130g 이상 + 접지 선택 |
| **동작** | 2단접지→오시1줄, 3단→2줄, 4단→3줄 자동 설정 |
| **해제** | 접지 해제 시 오시도 자동 해제 |
| **예외** | 오시 단독 선택은 평량 무관 가능 |
| **구현** | `handleFoldSelect()` (빌더 + 고객 페이지) |

```
130g 이상 + 접지 2단 → 오시 1줄 강제
130g 이상 + 접지 3단 → 오시 2줄 강제
130g 이상 + 접지 4단 → 오시 3줄 강제
130g 미만 + 접지      → 오시 강제 안 함
접지 해제             → 오시도 해제
오시만 단독 선택      → 항상 가능
```

### R002: 코팅 평량 제한

| 항목 | 내용 |
|------|------|
| **조건** | 용지 평량 150g 이하 |
| **동작** | 코팅 버튼 비활성화 (회색) + 툴팁 메시지 |
| **메시지** | "150g 이하 용지는 코팅이 불가합니다." |
| **구현** | `validateCoatingWeight()` (priceEngine.ts) |

```
용지 150g 이하 → 코팅 비활성화 (disabled-gray)
용지 151g 이상 → 코팅 선택 가능
```

### R-ST: 제본 두께 제한

| 제본 | 경고 | 차단 | 구현 |
|------|------|------|------|
| 중철 | 2.0mm | 2.5mm | `validateBindingThickness()` |
| 무선 | 40mm | 50mm | `validateBindingThickness()` |
| 스프링 | 15mm | 20mm | `validateBindingThickness()` |

**두께 계수 (mm/g):**

| 용지 | 계수 |
|------|------|
| 아트지/스노우지 | 0.0008 |
| 매트지 | 0.0009 |
| 아이보리 | 0.0010 |
| 크라프트 | 0.0012 |
| 기타 | 0.0010 |

### UI-001: 옵션 1개 자동 잠금

| 항목 | 내용 |
|------|------|
| **조건** | 블록 내 활성화된 옵션이 1개만 있을 때 |
| **동작** | 해당 블록 자동 잠금 (`locked: true`) |
| **구현** | ProductBuilder - 각 토글 함수 |

### UI-002: 더블클릭 기본값 (★)

| 항목 | 내용 |
|------|------|
| **조건** | 설정 패널에서 옵션 더블클릭 |
| **동작** | 해당 옵션을 ★ 기본값으로 설정 |
| **효과** | 고객 페이지 진입 시 해당 값이 선택된 상태로 표시 |
| **구현** | ProductBuilder BlockSettings - `onDoubleClick` |

**★ 기본값 적용 대상:**
- 사이즈, 용지, 인쇄, 출고일, 수량
- 후가공: 코팅, 코팅종류(무광/유광), 코팅면(단면/양면), 귀도리, 타공, 미싱

### BIND-FINISH: 제본 후가공 연동

| 항목 | 내용 |
|------|------|
| **조건** | 제본 상품 (무선/중철/스프링) + finishing block 존재 |
| **동작** | `customer.finishing.*` 키로 코팅/오시/접지/귀도리/타공/미싱 비용 계산 |
| **적용 대상** | 표지에만 적용 (coverFaces/coverSheets 기준) |
| **이중 방지** | `customer.coverCoating`이 이미 설정되면 finishing coating 무시 |
| **구현** | `calculateBindingPrice()` 섹션 5 (2026-02-05 추가) |
| **관련 버그** | ERR-001 - finishing 비용 전부 0원 문제 해결 |

### UI-003: 표지/내지 용지 분리

| 항목 | 내용 |
|------|------|
| **조건** | 무선/중철/스프링 제본 상품 |
| **동작** | 표지와 내지 용지 선택을 별도 블록으로 관리 |
| **키 매핑** | 표지: `coverPaper`/`coverWeight`, 내지: `innerPaper`/`innerWeight` |

---

## 2. 미적용 규칙

### R003: 무선 코팅 단면만

| 항목 | 내용 |
|------|------|
| **조건** | 무선제본 표지 |
| **동작** | 양면 코팅 비활성화 (접착면 필요) |
| **우선순위** | 낮음 |

### R004: 스프링 코팅 불가

| 항목 | 내용 |
|------|------|
| **조건** | 스프링제본 |
| **동작** | 코팅 블록 숨김 |
| **우선순위** | 중간 |

### R005: 중철 두께 제한 (강화)

| 항목 | 내용 |
|------|------|
| **조건** | 접힌 두께 > 2.5mm |
| **동작** | 주문 차단 + 경고 |
| **참고** | R-ST01/ST02로 부분 구현됨 |

### R006: 내지 두께 제한

| 항목 | 내용 |
|------|------|
| **조건** | 내지가 표지보다 두꺼울 때 |
| **동작** | 해당 내지 용지 비활성화 |

### R007: 무선 최소 페이지

| 항목 | 내용 |
|------|------|
| **조건** | 40페이지 미만 |
| **동작** | 주문 차단 + 안내 |

### R-SP01~03: 스프링 표지 자동화

| 규칙 | 조건 | 동작 |
|------|------|------|
| SP01 | 표지 = "없음" | 표지 옵션 숨김, 뒷판 활성화 |
| SP02 | 표지 = "PP표지" | 인쇄=단면 고정, PP 투명/불투명 선택, 뒷판 활성화 |
| SP03 | 표지 = "일반표지" | 인쇄=단면/양면 선택 가능, 뒷판 활성화 |

### R-PP: 후가공 호환성

| 규칙 | 조건 | 동작 |
|------|------|------|
| PP01 | 접지 + 귀도리 | 귀도리 비활성화 |
| PP02 | 코팅 + 미싱 | 미싱 비활성화 (코팅 벗겨짐) |
| PP03 | 스프링 + 코팅 | 코팅 비활성화 |

---

## 3. 규칙 통계

| 상태 | 수 |
|------|-----|
| 적용됨 (applied) | 11 |
| 미적용 (pending) | 12 |
| 합계 | 23 |

---

## 4. 규칙 적용 위치 요약

### priceEngine.ts

| 함수 | 규칙 |
|------|------|
| `validateCoatingWeight()` | R002 (코팅 150g 이하 차단) |
| `validateBindingThickness()` | R-ST01~07 (제본 두께 경고/차단) |
| `calculateBindingPrice()` 섹션 5 | 제본 후가공 비용 (finishing block 연동, 2026-02-05 추가) |

### ProductBuilder/index.jsx (관리자)

| 위치 | 규칙 |
|------|------|
| `handleFoldSelect()` | R001 (접지→오시 강제) |
| 접지 OFF 인라인 핸들러 | R001 (접지 해제→오시 해제) |
| finishing PreviewBlock | R002 (코팅 비활성화 UI) |
| 각 토글 함수 | UI-001 (옵션 1개 잠금) |
| BlockSettings `onDoubleClick` | UI-002 (★ 기본값) |

### ProductView.jsx (고객)

| 위치 | 규칙 |
|------|------|
| `handleFoldSelect()` | R001 (접지→오시 강제) |
| 접지 OFF 인라인 핸들러 | R001 (접지 해제→오시 해제) |
| finishing PreviewBlock | R002 (코팅 비활성화 UI) |
| `extractDefaultsFromBlocks()` | UI-002 (★ 기본값 로드) |
