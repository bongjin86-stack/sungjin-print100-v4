---
import { supabase } from "@/lib/supabase";

import "@/styles/fonts.css";
import "@/styles/tokens.css";
import "@/styles/global.scss";
import "@/styles/global.css"; // Tailwind CSS

interface Props {
  title: string;
  fullBleed?: boolean;
}

const { title, fullBleed = false } = Astro.props;

const currentPath = Astro.url.pathname;

// DB에서 로고 URL 조회
let logoUrl: string | null = null;
try {
  const { data } = await supabase
    .from("site_settings")
    .select("value")
    .eq("key", "logo_url")
    .single();
  if (data?.value) {
    logoUrl = data.value;
  }
} catch {
  // 없으면 기본 텍스트 사용
}

// 상시 노출 메뉴 (매일 사용)
const mainItems = [
  { href: "/admin/orders", label: "주문 관리" },
  { href: "/admin/products", label: "상품 관리" },
  { href: "/admin/news", label: "공지사항" },
];

// 접히는 그룹: 페이지 관리
const pageGroup = {
  key: "pages",
  title: "페이지 관리",
  items: [
    { href: "/admin/landing", label: "랜딩 페이지" },
    { href: "/admin/about", label: "회사소개" },
    { href: "/admin/services", label: "서비스" },
    { href: "/admin/works", label: "Works" },
    { href: "/admin/faq", label: "FAQ" },
  ],
};

// 접히는 그룹: 시스템
const systemGroup = {
  key: "system",
  title: "시스템",
  items: [
    { href: "/admin/db", label: "DB 관리" },
    { href: "/admin/settings", label: "설정" },
  ],
};

const collapsibleGroups = [pageGroup, systemGroup];

function isActive(href: string) {
  if (href === "/admin") {
    return currentPath === "/admin" || currentPath === "/admin/";
  }
  return currentPath.startsWith(href);
}

// 대시보드 단독 항목
const dashboardItem = { href: "/admin", label: "대시보드" };
---

<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} | Sungjinprint Admin</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>
  <body class="admin-body">
    <div class="admin-wrapper">
      <!-- Sidebar -->
      <aside class="admin-sidebar">
        <div class="admin-logo">
          <a href="/admin">
            {
              logoUrl ? (
                <img src={logoUrl} alt="Logo" class="admin-logo-img" />
              ) : (
                "Sungjinprint"
              )
            }
          </a>
          <span class="admin-badge">Admin</span>
        </div>
        <nav class="admin-nav">
          {/* 대시보드 */}
          <a
            href={dashboardItem.href}
            class:list={[
              "admin-nav-item",
              { active: isActive(dashboardItem.href) },
            ]}
          >
            {dashboardItem.label}
          </a>

          {/* 상시 노출 메뉴 */}
          {
            mainItems.map((item) => (
              <a
                href={item.href}
                class:list={["admin-nav-item", { active: isActive(item.href) }]}
              >
                {item.label}
              </a>
            ))
          }

          <div class="nav-divider"></div>

          {/* 접히는 그룹들 */}
          {
            collapsibleGroups.map((group) => {
              const hasActive = group.items.some((item) => isActive(item.href));
              return (
                <div class="nav-group" data-group={group.key} data-has-active={hasActive ? "true" : "false"}>
                  <button class="nav-group-toggle" type="button">
                    <span class="nav-group-arrow">&#9656;</span>
                    <span>{group.title}</span>
                  </button>
                  <ul class="nav-group-list">
                    {group.items.map((item) => (
                      <li>
                        <a
                          href={item.href}
                          class:list={[
                            "admin-nav-item",
                            { active: isActive(item.href) },
                          ]}
                        >
                          {item.label}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              );
            })
          }
        </nav>
        <div class="admin-sidebar-footer">
          <div class="admin-user-info">
            <span class="user-email" id="userEmail">로딩중...</span>
          </div>
          <a href="/" class="admin-nav-item" target="_blank"> 사이트 보기 </a>
          <button id="logoutButton" class="admin-nav-item logout-btn">
            로그아웃
          </button>
        </div>

        <script>
          import { supabase } from "@/lib/supabase";

          // 쿠키 설정 헬퍼
          function setAuthCookies(session) {
            if (!session) return;
            const secure = window.location.protocol === "https:";
            const cookieOpts = `path=/; max-age=${session.expires_in}; SameSite=Lax${secure ? "; Secure" : ""}`;
            document.cookie = `sb-access-token=${session.access_token}; ${cookieOpts}`;
            document.cookie = `sb-refresh-token=${session.refresh_token}; path=/; max-age=${60 * 60 * 24 * 7}; SameSite=Lax${secure ? "; Secure" : ""}`;
          }

          function clearAuthCookies() {
            document.cookie = "sb-access-token=; path=/; max-age=0";
            document.cookie = "sb-refresh-token=; path=/; max-age=0";
          }

          // 클라이언트 사이드 인증 체크 (서버 미들웨어가 1차 보호, 이건 2차)
          (async () => {
            const { data } = await supabase.auth.getSession();

            if (!data.session) {
              clearAuthCookies();
              window.location.href = "/admin/login";
              return;
            }

            // 쿠키 동기화 (토큰 갱신 시)
            setAuthCookies(data.session);

            // 사용자 이메일 표시
            const userEmailEl = document.getElementById("userEmail");
            if (userEmailEl) {
              userEmailEl.textContent = data.session.user.email || "";
            }
          })();

          // 토큰 자동 갱신 시 쿠키도 업데이트
          supabase.auth.onAuthStateChange((event, session) => {
            if (event === "TOKEN_REFRESHED" && session) {
              setAuthCookies(session);
            }
            if (event === "SIGNED_OUT") {
              clearAuthCookies();
            }
          });

          // 로그아웃 버튼
          document
            .getElementById("logoutButton")
            ?.addEventListener("click", async () => {
              await supabase.auth.signOut();
              clearAuthCookies();
              window.location.href = "/admin/login";
            });

          // 접히는 메뉴 그룹 토글
          const STORAGE_KEY = "admin-nav-collapsed";
          function getCollapsed() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch { return {}; }
          }
          function saveCollapsed(state) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          }

          document.querySelectorAll(".nav-group[data-group]").forEach((group) => {
            const key = group.dataset.group;
            const hasActive = group.dataset.hasActive === "true";
            const toggle = group.querySelector(".nav-group-toggle");
            const list = group.querySelector(".nav-group-list");
            const arrow = group.querySelector(".nav-group-arrow");
            const collapsed = getCollapsed();

            // 초기 상태: 활성 페이지 포함 시 열림, 아니면 저장된 상태 (기본 닫힘)
            const isOpen = hasActive || collapsed[key] === false;
            if (isOpen) {
              list.classList.add("open");
              arrow.classList.add("open");
            }

            toggle.addEventListener("click", () => {
              const nowOpen = list.classList.toggle("open");
              arrow.classList.toggle("open");
              const state = getCollapsed();
              state[key] = !nowOpen;
              saveCollapsed(state);
            });
          });
        </script>
      </aside>

      <!-- Main Content -->
      <main class="admin-main">
        {
          !fullBleed && (
            <header class="admin-header">
              <h1 class="admin-title">{title}</h1>
            </header>
          )
        }
        <div
          class:list={[
            "admin-content",
            { "admin-content--full-bleed": fullBleed },
          ]}
        >
          <slot />
        </div>
      </main>
    </div>

    <style lang="scss">
      .admin-body {
        margin: 0;
        padding: 0;
        font-family: var(--font-family);
        background-color: var(--c-bg-secondary);
        color: var(--c-text);
      }

      .admin-wrapper {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar - Nagi 스타일 */
      .admin-sidebar {
        width: 220px;
        background-color: var(--c-bg-inverse);
        color: var(--c-text-inverse);
        display: flex;
        flex-direction: column;
        position: fixed;
        height: 100vh;
        left: 0;
        top: 0;
      }

      .admin-logo {
        padding: var(--sp-lg);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: var(--sp-sm);
      }

      .admin-logo a {
        color: var(--c-text-inverse);
        text-decoration: none;
        font-size: var(--fs-lg);
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .admin-logo-img {
        height: 28px;
        width: auto;
        object-fit: contain;
        filter: brightness(0) invert(1); /* 흰색으로 변환 */
      }

      .admin-badge {
        background-color: var(--c-primary-light);
        color: var(--c-text-inverse);
        font-size: var(--fs-xs);
        padding: 2px 8px;
        border-radius: var(--radius-base);
        font-weight: 600;
        text-transform: uppercase;
      }

      .admin-nav {
        flex: 1;
        padding: var(--sp-md) 0;
        display: flex;
        flex-direction: column;
        gap: var(--sp-xs);
      }

      .admin-nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .nav-divider {
        height: 1px;
        background-color: rgba(255, 255, 255, 0.1);
        margin: var(--sp-sm) var(--sp-lg);
      }

      .nav-group {
        margin-top: var(--sp-xs);
      }

      .nav-group-toggle {
        display: flex;
        align-items: center;
        gap: var(--sp-xs);
        width: 100%;
        padding: var(--sp-sm) var(--sp-lg);
        background: none;
        border: none;
        cursor: pointer;
        font-family: inherit;
        font-size: var(--fs-xs);
        font-weight: 600;
        color: var(--c-text-inverse-sub);
        letter-spacing: 0.03em;
        opacity: 0.7;
        transition: opacity var(--transition-fast);
      }

      .nav-group-toggle:hover {
        opacity: 1;
      }

      .nav-group-arrow {
        font-size: 10px;
        transition: transform 0.2s ease;
        display: inline-block;
      }

      .nav-group-arrow.open {
        transform: rotate(90deg);
      }

      .nav-group-list {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.25s ease;
      }

      .nav-group-list.open {
        max-height: 300px;
      }

      .admin-nav-item {
        display: block;
        padding: var(--sp-md) var(--sp-lg);
        color: var(--c-text-inverse-sub);
        text-decoration: none;
        font-size: var(--fs-sm);
        transition: all var(--transition-fast);
        border-left: 3px solid transparent;
      }

      .admin-nav-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--c-text-inverse);
      }

      .admin-nav-item.active {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--c-text-inverse);
        border-left-color: var(--c-text-inverse);
      }

      .admin-sidebar-footer {
        padding: var(--sp-md) 0;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .admin-user-info {
        padding: var(--sp-sm) var(--sp-lg);
        margin-bottom: var(--sp-xs);
      }

      .user-email {
        font-size: var(--fs-xs);
        color: var(--c-text-inverse-sub);
        word-break: break-all;
      }

      .logout-btn {
        width: 100%;
        background: none;
        border: none;
        cursor: pointer;
        text-align: left;
        font-family: inherit;
        color: #f87171;
      }

      .logout-btn:hover {
        background-color: rgba(248, 113, 113, 0.1);
        color: #ef4444;
      }

      /* Main - Nagi 스타일 */
      .admin-main {
        flex: 1;
        margin-left: 220px;
        min-height: 100vh;
      }

      .admin-header {
        background-color: var(--c-bg);
        padding: var(--sp-lg) var(--sp-xl);
        border-bottom: 1px solid var(--c-border-light);
      }

      .admin-title {
        margin: 0;
        font-size: var(--fs-xl);
        font-weight: 700;
        color: var(--c-text);
        letter-spacing: -0.02em;
      }

      .admin-content {
        padding: var(--sp-xl);
      }

      .admin-content--full-bleed {
        padding: 0;
        background-color: var(--c-bg);
      }

      /* Responsive */
      @media (max-width: 900px) {
        .admin-sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }

        .admin-main {
          margin-left: 0;
        }
      }
    </style>
  </body>
</html>
