---
import Container from "@/components/layout/Container.astro";
import Section from "@/components/layout/Section.astro";
import LinkText from "@/components/ui/LinkText.astro";
import SectionTitle from "@/components/ui/SectionTitle.astro";

import { supabase } from "../../lib/supabase";

// 랜딩 페이지 설정에서 상품 설정 가져오기
const { data: settings } = await supabase
  .from("site_settings")
  .select("key, value")
  .in("key", [
    "landing_products_ids",
    "landing_products_count",
    "landing_products_title",
    "landing_products_subtitle",
    "landing_products_link_text",
  ]);

const configMap: Record<string, string> = {};
(settings || []).forEach((s: { key: string; value: string }) => {
  configMap[s.key] = s.value;
});

let productIds: string[] = [];
try {
  productIds = JSON.parse(configMap.landing_products_ids || "[]");
} catch {
  productIds = [];
}

const maxCount = parseInt(configMap.landing_products_count || "6", 10);
const sectionTitle = configMap.landing_products_title || "Products";
const sectionSubtitle = configMap.landing_products_subtitle || "인쇄 상품";
const linkText = configMap.landing_products_link_text || "View all products";

// 선택된 상품 또는 최신 상품 가져오기
let prints: any[] = [];

if (productIds.length > 0) {
  // 관리자가 선택한 순서대로 가져오기
  const { data } = await supabase
    .from("prints")
    .select("*")
    .in("id", productIds)
    .eq("is_published", true);

  if (data) {
    // 관리자가 설정한 순서 유지
    const dataMap = new Map(data.map((d: any) => [d.id, d]));
    prints = productIds
      .map((id) => dataMap.get(id))
      .filter(Boolean)
      .slice(0, maxCount);
  }
} else {
  // 기본: 최신 published prints
  const { data } = await supabase
    .from("prints")
    .select("*")
    .eq("is_published", true)
    .order("sort_order", { ascending: true })
    .limit(maxCount);

  prints = data || [];
}

const totalSlides = prints.length;
---

{
  prints.length > 0 && (
    <Section background="primary">
      <Container>
        <div class="prints-showcase-inner">
          <div class="prints-showcase-header">
            <SectionTitle title={sectionTitle} subtitle={sectionSubtitle} />
            <div class="header-right">
              <span class="slide-indicator">
                <span class="slide-current">1</span> — {totalSlides}
              </span>
              <LinkText href="/prints/" ariaLabel="전체 상품 보기">
                {linkText}
              </LinkText>
            </div>
          </div>

          <div class="prints-carousel">
            <div class="carousel-track">
              {prints.map((item: any, index: number) => (
                <article
                  class={`carousel-card ${index === 0 ? "card-featured" : "card-regular"}`}
                  data-animate
                >
                  <a href={`/prints/${item.id}`} class="card-link">
                    <div class="card-image">
                      {item.image ? (
                        <img
                          src={item.image}
                          alt={item.title}
                          width="600"
                          height="750"
                          loading="lazy"
                        />
                      ) : (
                        <div class="card-placeholder">No Image</div>
                      )}
                    </div>
                    <div class="card-content">
                      {item.tag && (
                        <span class="card-category">{item.tag}</span>
                      )}
                      <h3 class="card-title">{item.title}</h3>
                      {item.description && (
                        <p class="card-description">{item.description}</p>
                      )}
                    </div>
                  </a>
                </article>
              ))}
            </div>
          </div>
        </div>
      </Container>
    </Section>
  )
}

<script>
  function initCarousel() {
    const track = document.querySelector(
      ".carousel-track"
    ) as HTMLElement | null;
    const indicator = document.querySelector(
      ".slide-current"
    ) as HTMLElement | null;
    if (!track || !indicator) return;

    const cards = track.querySelectorAll(".carousel-card");
    if (cards.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const idx = Array.from(cards).indexOf(entry.target as HTMLElement);
            if (idx >= 0) {
              indicator.textContent = String(idx + 1);
            }
          }
        });
      },
      {
        root: track,
        threshold: 0.6,
      }
    );

    cards.forEach((card) => observer.observe(card));
  }

  document.addEventListener("DOMContentLoaded", initCarousel);
  document.addEventListener("astro:page-load", initCarousel);
</script>

<style lang="scss">
  /* Header */
  .prints-showcase-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--sp-lg);
    margin-bottom: var(--sp-3xl);
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: var(--sp-xl);
  }

  .slide-indicator {
    display: none;
    color: var(--c-text-sub);
    font-size: var(--fs-sm);
    font-weight: 400;
    letter-spacing: 0.05em;
    white-space: nowrap;

    @media (min-width: 900px) {
      display: block;
    }
  }

  /* Carousel */
  .prints-carousel {
    overflow: hidden;

    @media (min-width: 900px) {
      overflow: visible;
    }
  }

  .carousel-track {
    display: flex;
    gap: var(--sp-lg);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;

    /* Hide scrollbar */
    scrollbar-width: none;
    -ms-overflow-style: none;
    &::-webkit-scrollbar {
      display: none;
    }

    @media (min-width: 900px) {
      gap: var(--sp-xl);
    }
  }

  /* Cards */
  .carousel-card {
    flex-shrink: 0;
    scroll-snap-align: start;
  }

  .card-featured {
    width: 80%;

    @media (min-width: 900px) {
      width: 55%;
    }
  }

  .card-regular {
    width: 65%;

    @media (min-width: 900px) {
      width: 35%;
    }
  }

  .card-link {
    display: block;
    transition: transform var(--transition-slow);

    &:hover {
      transform: translateY(-4px);
    }
  }

  .card-image {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: var(--radius-3xl);

    img {
      width: 100%;
      height: auto;
      object-fit: cover;
      aspect-ratio: 4 / 5;
      transition: transform var(--transition-slower);
    }

    .carousel-card:hover & img {
      transform: scale(1.03);
    }
  }

  .card-placeholder {
    width: 100%;
    aspect-ratio: 4 / 5;
    background-color: var(--c-bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--c-text-sub);
    border-radius: var(--radius-3xl);
  }

  .card-content {
    display: flex;
    flex-direction: column;
    gap: var(--sp-xs);
    margin: var(--sp-lg) 0 0;
  }

  .card-category {
    color: var(--c-text-sub);
    font-size: var(--fs-xs);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    line-height: var(--lh-tight);
  }

  .card-title {
    color: var(--c-text);
    font-size: var(--fs-md);
    font-weight: 500;
    line-height: var(--lh-snug);

    .card-featured & {
      font-size: var(--fs-lg);

      @media (min-width: 900px) {
        font-size: var(--fs-xl);
      }
    }
  }

  .card-description {
    color: var(--c-text-sub);
    font-size: var(--fs-sm);
    line-height: var(--lh-relaxed);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;

    @media (min-width: 900px) {
      font-size: var(--fs-base);
    }
  }
</style>
