---
import Container from "@/components/layout/Container.astro";
import Section from "@/components/layout/Section.astro";
import LinkText from "@/components/ui/LinkText.astro";
import SectionTitle from "@/components/ui/SectionTitle.astro";
import { supabase } from "@/lib/supabase";

// News 카테고리 정의
const categoryList = [
  { id: "information", title: "안내" },
  { id: "event", title: "이벤트" },
  { id: "update", title: "업데이트" },
];

// DB에서 최신 News 4개 가져오기
const { data: latestNews, error } = await supabase
  .from("news")
  .select("*")
  .order("pub_date", { ascending: false })
  .limit(4);

if (error) {
  console.error("Error fetching news:", error);
}

const newsData = latestNews || [];

// 카테고리 ID로 카테고리 제목 찾기
function getCategoryTitle(categoryId: string): string {
  const cat = categoryList.find((c) => c.id === categoryId);
  return cat?.title || categoryId;
}

// 날짜 포맷팅
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date
    .toLocaleDateString("ko-KR", {
      year: "numeric",
      month: "numeric",
      day: "numeric",
    })
    .replace(/\//g, ".");
}
---

<Section background="primary">
  <Container>
    <div class="news-inner">
      <div class="news-header">
        <SectionTitle title="News" subtitle="공지사항" />
        <LinkText href="/news/" ariaLabel="공지사항 전체보기">
          전체보기
        </LinkText>
      </div>

      <div class="news-list">
        {
          newsData.map((news) => (
            <article class="news-item">
              <a href={`/news/${news.id}`} class="news-link">
                <time class="news-date" datetime={news.pub_date}>
                  {formatDate(news.pub_date)}
                </time>
                <span class="news-category">
                  {getCategoryTitle(news.category)}
                </span>
                <h3 class="news-item-title">{news.title}</h3>
              </a>
            </article>
          ))
        }
      </div>
    </div>
  </Container>
</Section>

<style lang="scss">
  .news-inner {
    @media (min-width: 900px) {
      display: grid;
      grid-template-columns: 20% 1fr;
      gap: 0 var(--sp-4xl);
    }
  }

  .news-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--sp-lg);
    margin-bottom: var(--sp-3xl);

    @media (min-width: 900px) {
      flex-direction: column;
      align-items: start;
      align-self: start;
      margin-bottom: 0;
    }
  }

  .news-list {
    display: flex;
    flex-direction: column;
    gap: var(--sp-xl);
    width: 100%;
    margin: 0 auto;

    @media (min-width: 600px) {
      gap: var(--sp-md);
    }
  }

  .news-link {
    display: grid;
    grid-template-columns: auto 1fr;
    grid-template-rows: auto auto;
    align-items: center;
    gap: var(--sp-sm) var(--sp-xs);
    color: var(--c-text);
    text-decoration: none;

    @media (min-width: 600px) {
      grid-template-columns: auto 120px 1fr;
      grid-template-rows: auto;
      gap: 0 var(--sp-sm);
    }
  }

  .news-date {
    grid-column: 1 / 2;
    grid-row: 1 / 2;
    color: var(--c-text-sub);
    font-size: var(--fs-sm);
    align-self: center;
    white-space: nowrap;
    min-width: 80px;

    @media (min-width: 600px) {
      grid-column: 1 / 2;
      font-size: var(--fs-base);
      min-width: 90px;
    }
  }

  .news-category {
    grid-column: 2 / 3;
    grid-row: 1 / 2;
    width: fit-content;
    padding: var(--sp-xs) var(--sp-sm);
    background-color: var(--c-bg-secondary);
    color: var(--c-text);
    font-size: var(--fs-xs);
    line-height: var(--lh-none);
    text-transform: uppercase;
    border-radius: var(--radius-md);

    @media (min-width: 600px) {
      grid-column: 2 / 3;
    }
  }

  .news-item-title {
    grid-column: 1 / 3;
    grid-row: 2 / 3;
    color: var(--c-text);
    font-size: var(--fs-sm);
    line-height: var(--lh-relaxed);

    @media (min-width: 600px) {
      grid-column: 3 / -1;
      grid-row: 1 / 2;
    }

    @media (min-width: 900px) {
      font-size: var(--fs-base);
    }

    .news-link:hover & {
      text-decoration: underline;
      text-underline-offset: 4px;
    }
  }
</style>
