---
import Container from "@/components/layout/Container.astro";
import Section from "@/components/layout/Section.astro";
import SectionTitle from "@/components/ui/SectionTitle.astro";
import { renderBlocksToHTML } from "@/lib/blockRenderer";
import { supabase } from "@/lib/supabase";

interface Props {
  settings?: Record<string, string>;
}

const { settings = {} } = Astro.props;

// DB에서 팀 데이터 가져오기
const { data: teamMembers, error } = await supabase
  .from("team")
  .select("*")
  .order("sort_order", { ascending: true });

if (error) {
  console.error("Error fetching team:", error);
}

// 섹션 제목/부제목/설명
const sectionTitle = settings["team_title"] || "Meet Our Team";
const sectionSubtitle = settings["team_subtitle"] || "팀 소개";
const teamDescriptionRaw =
  settings["team_description"] ||
  "성진인쇄는 전문 인력과 최신 장비를 갖추고 고객 만족을 위해 최선을 다하고 있습니다. 다양한 배경을 가진 팀원들이 각자의 전문성을 살려 혁신적인 인쇄 경험을 만들어가고 있습니다. 고객의 비전을 실현하기 위해 항상 배우고 도전하는 팀입니다.";

// BlockNote JSON 또는 마크다운을 HTML로 변환
const teamDescription = renderBlocksToHTML(teamDescriptionRaw);
---

<Section>
  <Container>
    <div class="team-header">
      <SectionTitle title={sectionTitle} subtitle={sectionSubtitle} />
      <div class="team-description" set:html={teamDescription} />
    </div>

    <div class="team-grid">
      {
        teamMembers &&
          teamMembers.map((member) => (
            <article class:list={["team-member", { "-pet": member.is_pet }]}>
              <div class="team-member-image">
                {member.image_path ? (
                  <img
                    src={member.image_path}
                    alt={member.name}
                    class="team-image"
                  />
                ) : (
                  <div class="team-image-placeholder" />
                )}
              </div>
              <div class="team-member-info">
                <h3 class="team-member-name">{member.name}</h3>
                <p class="team-member-position">{member.position}</p>
              </div>
            </article>
          ))
      }
    </div>
  </Container>
</Section>

<style lang="scss">
  .team-header {
    display: flex;
    flex-direction: column;
    gap: var(--sp-lg);
    max-width: var(--container-sm);
    margin: 0 0 var(--sp-3xl);

    @media (min-width: 900px) {
      gap: var(--sp-xl);
      margin-bottom: var(--sp-4xl);
    }
  }

  .team-description {
    color: var(--c-text-sub);
    font-size: var(--fs-base);
    line-height: var(--lh-loose);
    letter-spacing: 0.01em;

    @media (min-width: 900px) {
      font-size: var(--fs-md);
    }

    :global(p) {
      margin: 0 0 1em;
    }

    :global(p:last-child) {
      margin-bottom: 0;
    }
  }

  .team-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--sp-xl);

    @media (min-width: 600px) {
      grid-template-columns: repeat(3, 1fr);
      gap: var(--sp-2xl);
    }

    @media (min-width: 900px) {
      grid-template-columns: repeat(4, 1fr);
      gap: var(--sp-2xl);
    }
  }

  .team-member {
    display: flex;
    flex-direction: column;
    gap: var(--sp-md);
  }

  .team-member-image {
    position: relative;
    width: 100%;
    border-radius: var(--radius-xl);
    overflow: hidden;
    background-color: var(--c-bg-secondary);

    .team-member.-pet & {
      border-radius: var(--radius-full);
    }
  }

  .team-image {
    display: block;
    width: 100%;
    height: auto;
    object-fit: cover;
    aspect-ratio: 1 / 1;
  }

  .team-image-placeholder {
    width: 100%;
    aspect-ratio: 1 / 1;
    background-color: var(--c-bg-secondary);
  }

  .team-member-info {
    display: flex;
    flex-direction: column;
    gap: var(--sp-xs);
    text-align: center;
  }

  .team-member-name {
    color: var(--c-text);
    font-size: var(--fs-base);
    font-weight: 500;
    letter-spacing: 0.01em;

    @media (min-width: 900px) {
      font-size: var(--fs-md);
    }
  }

  .team-member-position {
    color: var(--c-text-sub);
    font-size: var(--fs-sm);
    letter-spacing: 0.01em;

    @media (min-width: 900px) {
      font-size: var(--fs-base);
    }
  }
</style>
