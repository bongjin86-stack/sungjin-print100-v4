---
import ChevronDownIcon from "@/assets/icons/chevron-down.svg";
import Container from "@/components/layout/Container.astro";
import LinkButton from "@/components/ui/LinkButton.astro";
import MobileMenu from "@/components/ui/MobileMenu.astro";
import SiteLogo from "@/components/ui/SiteLogo.astro";
import menuData from "@/config/menu.json";
import siteConfig from "@/config/site.config.json";
import { supabase } from "@/lib/supabase";
import type { MenuData, MenuItem } from "@/types/index.d.ts";

const typedMenuData = menuData as MenuData;
const contactMenu = typedMenuData.contact;

// DB에서 활성 서비스 목록을 가져와 "서비스" 드롭다운을 동적으로 구성
const { data: services } = await supabase
  .from("services")
  .select("title, slug")
  .eq("is_active", true)
  .order("sort_order", { ascending: true });

const mainMenu: MenuItem[] = typedMenuData.main.map((item) => {
  if (item.path === "/services/" && services && services.length > 0) {
    return {
      ...item,
      children: services.map((s) => ({
        title: s.title,
        path: `/services/#${s.slug}`,
      })),
    };
  }
  return item;
});

const headerHeight = siteConfig.settings.header_height;
const headerHeightMobile = siteConfig.settings.header_height_mobile;
const isHome = Astro.url.pathname === "/";
---

<header class="header" id="header">
  <Container>
    <div class="header-inner">
      <SiteLogo h1={isHome} class="header-logo" />

      <nav class="header-nav">
        <ul class="nav-list">
          {
            mainMenu.map((item) => (
              <li class="nav-item">
                <a href={item.path} class="nav-link">
                  {item.title}
                  {item.children && <ChevronDownIcon width={16} height={16} />}
                </a>
                {item.children && (
                  <div class="nav-dropdown">
                    <ul class="dropdown-menu">
                      {item.children.map((child) => (
                        <li class="dropdown-item">
                          <a href={child.path} class="dropdown-link">
                            {child.title}
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
              </li>
            ))
          }
          <li>
            <LinkButton
              href={contactMenu.path}
              ariaLabel={contactMenu.title}
              size="small"
              class="menu-contact"
            >
              {contactMenu.title}
            </LinkButton>
          </li>
        </ul>
      </nav>
      <MobileMenu mainMenu={mainMenu} />
    </div>
  </Container>
</header>

<style lang="scss" define:vars={{ headerHeight, headerHeightMobile }}>
  .header {
    position: sticky;
    top: 0;
    display: grid;
    place-items: center;
    width: 100%;
    z-index: var(--z-sticky);
    height: var(--headerHeightMobile);
    background-color: var(--c-bg);
    transition:
      transform var(--transition-slower) var(--ease-out-quart),
      height 0.4s ease;

    &.is-hidden {
      transform: translateY(-100%);
    }

    @media (min-width: 1000px) {
      height: var(--headerHeight);
    }
  }

  .header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
  }

  .header-logo {
    flex-shrink: 0;
    z-index: var(--z-fixed);

    :global(svg),
    :global(.logo-img) {
      transition: height 0.4s ease;
    }
  }

  .header-nav {
    display: none;

    @media (min-width: 1000px) {
      display: block;
    }
  }

  .nav-list {
    display: flex;
    align-items: center;
    gap: var(--sp-xl);
    transition: gap 0.4s ease;
  }

  .nav-item {
    position: relative;
  }

  .nav-link {
    position: relative;
    display: flex;
    align-items: center;
    gap: var(--sp-xs);
    padding: var(--sp-sm) 0;
    color: var(--c-text);
    font-size: var(--fs-base);
    font-weight: 500;
    text-decoration: none;
    transition:
      color var(--transition-fast),
      font-size 0.4s ease;

    &::before {
      content: "";
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 100%;
      height: 2px;
      background-color: var(--c-link);
      transform: translateX(-50%) scaleX(0);
      transform-origin: center;
      transition: transform var(--transition-slow);
    }

    &:hover {
      color: var(--c-link);

      &::before {
        transform: translateX(-50%) scaleX(1);
      }
    }
  }

  .nav-dropdown {
    position: relative;
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 200px;
    margin-top: var(--sp-sm);
    padding: var(--sp-sm);
    background-color: var(--c-bg);
    border: 1px solid var(--c-border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition:
      opacity var(--transition-slow),
      visibility var(--transition-slow),
      transform var(--transition-slow);
    overflow-y: hidden;

    .nav-item:has(.dropdown-menu):is(:hover, :focus-within) & {
      pointer-events: auto;
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
  }

  .dropdown-link {
    display: block;
    padding: var(--sp-sm) var(--sp-md);
    color: var(--c-text);
    border-radius: var(--radius-md);
    font-size: var(--fs-sm);
    text-decoration: none;
    transition: background-color var(--transition-slow) ease;

    &:hover {
      background-color: var(--c-bg-secondary);
      color: var(--c-link);
    }
  }

  /* ── Compact mode (Edu+100 등 풀프레임 페이지) ── */
  .header--compact {
    height: 44px;

    @media (min-width: 1000px) {
      height: 48px;
    }

    /* Container 패딩 최소화 → 양쪽 끝으로 밀착 */
    :global(.container) {
      max-width: 100%;
      padding: 0 var(--sp-sm);

      @media (min-width: 600px) {
        padding: 0 var(--sp-md);
      }
    }

    /* 로고 축소 */
    :global(.logo) {
      :global(svg),
      :global(.logo-img) {
        height: 22px !important;
        transition: height 0.4s ease;

        @media (min-width: 900px) {
          height: 26px !important;
        }
      }
    }

    /* 네비 메뉴 축소 — 간격 좁히고 글씨 작게 */
    .nav-list {
      gap: var(--sp-md);
      transition: gap 0.4s ease;
    }

    .nav-link {
      font-size: var(--fs-xs);
      font-weight: 400;
      transition:
        font-size 0.4s ease,
        color var(--transition-fast);
    }

    /* 문의하기 버튼 축소 */
    :global(.menu-contact) {
      font-size: var(--fs-xs) !important;
      padding: var(--sp-xs) var(--sp-md) !important;
      transition: all 0.4s ease !important;
    }
  }
</style>

<script>
  // ── Compact mode: URL 기반 클래스 토글 ──
  // transition:persist로 헤더 DOM이 유지되므로
  // 페이지 전환 시 CSS transition이 실시간 작동
  const COMPACT_PATHS = ["/edu100"];

  function updateCompactMode() {
    const header = document.getElementById("header");
    if (!header) return;
    const isCompact = COMPACT_PATHS.some((p) => window.location.pathname.startsWith(p));
    if (isCompact) {
      header.classList.add("header--compact");
    } else {
      header.classList.remove("header--compact");
    }
  }

  // 초기 로드
  updateCompactMode();

  // Astro 페이지 전환 시 (ClientRouter)
  document.addEventListener("astro:after-swap", updateCompactMode);

  // ── 스크롤 시 헤더 자동 숨김 ──
  let lastScroll = 0;
  let ticking = false;

  const updateHeader = () => {
    const header = document.getElementById("header");
    const currentScroll = window.scrollY;

    if (currentScroll <= 0) {
      header?.classList.remove("is-hidden");
      lastScroll = currentScroll;
      ticking = false;
      return;
    }

    if (currentScroll > lastScroll && currentScroll > 100) {
      header?.classList.add("is-hidden");
    } else if (currentScroll < lastScroll) {
      header?.classList.remove("is-hidden");
    }

    lastScroll = currentScroll;
    ticking = false;
  };

  const onScroll = () => {
    if (!ticking) {
      requestAnimationFrame(updateHeader);
      ticking = true;
    }
  };

  window.addEventListener("scroll", onScroll, { passive: true });
</script>
