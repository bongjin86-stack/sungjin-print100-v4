---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { supabase } from "../../../lib/supabase";

// ë¸”ë¡œê·¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
const { data: blogList, error } = await supabase
  .from("blog_posts")
  .select("*")
  .order("pub_date", { ascending: false });

const categories: Record<string, string> = {
  general: "ì¼ë°˜",
  design: "ë””ìì¸",
  printing: "ì¸ì‡„",
  guide: "ê°€ì´ë“œ",
  news: "ì†Œì‹",
};
---

<AdminLayout title="ë¸”ë¡œê·¸ ê´€ë¦¬">
  <div class="blog-admin">
    <div class="admin-actions">
      <a href="/admin/blog/new" class="btn-primary">
        <span>+</span> ìƒˆ ê¸€ ì‘ì„±
      </a>
    </div>

    <div class="blog-table-wrapper">
      {
        error ? (
          <div class="error-state">
            <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            <p class="error-detail">{error.message}</p>
          </div>
        ) : blogList && blogList.length > 0 ? (
          <table class="blog-table">
            <thead>
              <tr>
                <th>ì œëª©</th>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>ìƒíƒœ</th>
                <th>ë°œí–‰ì¼</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              {blogList.map((post) => (
                <tr>
                  <td class="blog-title-cell">
                    <a href={`/admin/blog/${post.id}`}>
                      {post.title}
                      {post.image && <span class="has-image" title="ì´ë¯¸ì§€ ìˆìŒ">ğŸ–¼</span>}
                    </a>
                    {post.excerpt && (
                      <p class="blog-excerpt">{post.excerpt.substring(0, 60)}...</p>
                    )}
                  </td>
                  <td>
                    <span class={`category-badge category-${post.category}`}>
                      {categories[post.category] || post.category}
                    </span>
                  </td>
                  <td>
                    <span class={`status-badge ${post.is_published ? "published" : "draft"}`}>
                      {post.is_published ? "ê³µê°œ" : "ë¹„ê³µê°œ"}
                    </span>
                  </td>
                  <td>{new Date(post.pub_date).toLocaleDateString("ko-KR")}</td>
                  <td class="actions-cell">
                    <a href={`/admin/blog/${post.id}`} class="btn-edit">ìˆ˜ì •</a>
                    <button class="btn-delete" data-id={post.id}>ì‚­ì œ</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        ) : (
          <div class="empty-state">
            <div class="empty-icon">ğŸ“</div>
            <h3>ë“±ë¡ëœ ë¸”ë¡œê·¸ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ìƒˆ ë¸”ë¡œê·¸ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”.</p>
            <a href="/admin/blog/new" class="btn-primary">ê¸€ ì‘ì„±í•˜ê¸°</a>
          </div>
        )
      }
    </div>
  </div>

  <style>
    .blog-admin {
      max-width: 1200px;
    }

    .admin-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 24px;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #4f46e5;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 500;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #4338ca;
    }

    .blog-table-wrapper {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .blog-table {
      width: 100%;
      border-collapse: collapse;
    }

    .blog-table th,
    .blog-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    .blog-table th {
      background: #f9f9f9;
      font-weight: 600;
      color: #666;
      font-size: 0.875rem;
    }

    .blog-table tbody tr:hover {
      background: #fafafa;
    }

    .blog-title-cell a {
      color: #333;
      text-decoration: none;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .blog-title-cell a:hover {
      color: #4f46e5;
    }

    .blog-excerpt {
      color: #9ca3af;
      font-size: 0.75rem;
      margin: 4px 0 0;
    }

    .has-image {
      font-size: 0.75rem;
    }

    .category-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .category-general { background: #f3f4f6; color: #374151; }
    .category-design { background: #fce7f3; color: #be185d; }
    .category-printing { background: #dbeafe; color: #1d4ed8; }
    .category-guide { background: #d1fae5; color: #059669; }
    .category-news { background: #e0e7ff; color: #4338ca; }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-badge.published {
      background: #d1fae5;
      color: #059669;
    }

    .status-badge.draft {
      background: #f3f4f6;
      color: #6b7280;
    }

    .actions-cell {
      display: flex;
      gap: 8px;
    }

    .btn-edit {
      padding: 6px 12px;
      background: #f3f4f6;
      color: #374151;
      border-radius: 6px;
      text-decoration: none;
      font-size: 0.875rem;
    }

    .btn-edit:hover {
      background: #e5e7eb;
    }

    .btn-delete {
      padding: 6px 12px;
      background: #fef2f2;
      color: #dc2626;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .btn-delete:hover {
      background: #fee2e2;
    }

    .empty-state {
      text-align: center;
      padding: 64px 32px;
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .empty-state h3 {
      margin: 0 0 8px 0;
      color: #333;
    }

    .empty-state p {
      color: #666;
      margin: 0 0 24px 0;
    }

    .error-state {
      text-align: center;
      padding: 64px 32px;
      color: #dc2626;
    }

    .error-detail {
      font-size: 0.875rem;
      color: #666;
    }
  </style>

  <script>
    document.querySelectorAll(".btn-delete").forEach((button) => {
      button.addEventListener("click", async (e) => {
        const id = (e.target as HTMLElement).dataset.id;
        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          try {
            const response = await fetch(`/api/blog/${id}`, {
              method: "DELETE",
            });
            if (response.ok) {
              window.location.reload();
            } else {
              alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          } catch (error) {
            alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        }
      });
    });
  </script>
</AdminLayout>
