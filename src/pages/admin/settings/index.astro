---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabase } from '../../../lib/supabase';

export const prerender = false;

// site_settings 테이블에서 설정 가져오기 (key/value 구조)
const { data: settingsData, error } = await supabase
  .from('site_settings')
  .select('key, value');

// key/value 배열을 객체로 변환
const siteSettings: Record<string, string> = {};
if (settingsData) {
  for (const item of settingsData) {
    siteSettings[item.key] = item.value || '';
  }
}

// 기본값 설정
const settings = {
  site_name: siteSettings.site_name || 'Sungjinprint',
  site_description: siteSettings.site_description || '성진프린트 - 고품질 인쇄 서비스',
  contact_email: siteSettings.contact_email || '',
  contact_phone: siteSettings.contact_phone || '',
  contact_address: siteSettings.contact_address || '',
  service_intro: siteSettings.service_intro || '',
  // 사업장 정보
  company_name: siteSettings.company_name || '',
  ceo_name: siteSettings.ceo_name || '',
  business_number: siteSettings.business_number || '',
  phone: siteSettings.phone || '',
  email: siteSettings.email || '',
  address: siteSettings.address || '',
  google_maps_url: siteSettings.google_maps_url || '',
  business_hours: siteSettings.business_hours || '',
  business_hours_weekend: siteSettings.business_hours_weekend || '',
  bank_name: siteSettings.bank_name || '',
  bank_account: siteSettings.bank_account || '',
  bank_account_holder: siteSettings.bank_account_holder || ''
};
---

<AdminLayout title="사이트 설정">
  <div class="admin-header">
    <h1>사이트 설정</h1>
  </div>

  <form id="settings-form" class="settings-form">
    <div class="form-section">
      <h2>기본 정보</h2>
      
      <div class="form-group">
        <label for="site_name">사이트 이름</label>
        <input type="text" id="site_name" name="site_name" value={settings.site_name} />
      </div>

      <div class="form-group">
        <label for="site_description">사이트 설명</label>
        <textarea id="site_description" name="site_description" rows="3">{settings.site_description}</textarea>
      </div>
    </div>

    <div class="form-section">
      <h2>사업장 정보 (Footer 표시)</h2>
      
      <div class="form-group">
        <label for="company_name">회사명</label>
        <input type="text" id="company_name" name="company_name" value={settings.company_name} />
      </div>

      <div class="form-group">
        <label for="ceo_name">대표자명</label>
        <input type="text" id="ceo_name" name="ceo_name" value={settings.ceo_name} />
      </div>

      <div class="form-group">
        <label for="business_number">사업자등록번호</label>
        <input type="text" id="business_number" name="business_number" value={settings.business_number} placeholder="123-45-67890" />
      </div>

      <div class="form-group">
        <label for="phone">전화번호</label>
        <input type="tel" id="phone" name="phone" value={settings.phone} placeholder="02-448-3601" />
      </div>

      <div class="form-group">
        <label for="email">이메일</label>
        <input type="email" id="email" name="email" value={settings.email} placeholder="info@sungjinprint.com" />
      </div>

      <div class="form-group">
        <label for="address">주소</label>
        <input type="text" id="address" name="address" value={settings.address} />
      </div>

      <div class="form-group">
        <label for="google_maps_url">구글맵 URL</label>
        <input type="url" id="google_maps_url" name="google_maps_url" value={settings.google_maps_url} placeholder="https://maps.app.goo.gl/..." />
        <p class="form-hint">주소 클릭 시 연결될 구글맵 링크</p>
      </div>
    </div>

    <div class="form-section">
      <h2>운영시간</h2>
      
      <div class="form-group">
        <label for="business_hours">평일 운영시간</label>
        <input type="text" id="business_hours" name="business_hours" value={settings.business_hours} placeholder="평일 09:00 - 18:00" />
      </div>

      <div class="form-group">
        <label for="business_hours_weekend">주말 운영시간</label>
        <input type="text" id="business_hours_weekend" name="business_hours_weekend" value={settings.business_hours_weekend} placeholder="주말 및 공휴일 휴무" />
      </div>
    </div>

    <div class="form-section">
      <h2>결제 정보</h2>
      
      <div class="form-group">
        <label for="bank_name">은행명</label>
        <input type="text" id="bank_name" name="bank_name" value={settings.bank_name} placeholder="하나은행" />
      </div>

      <div class="form-group">
        <label for="bank_account">계좌번호</label>
        <input type="text" id="bank_account" name="bank_account" value={settings.bank_account} placeholder="585-910026-36407" />
      </div>

      <div class="form-group">
        <label for="bank_account_holder">예금주</label>
        <input type="text" id="bank_account_holder" name="bank_account_holder" value={settings.bank_account_holder} placeholder="(주)성진삼점오" />
      </div>
    </div>

    <div class="form-section">
      <h2>연락처 정보 (기존)</h2>
      
      <div class="form-group">
        <label for="contact_email">이메일</label>
        <input type="email" id="contact_email" name="contact_email" value={settings.contact_email} />
      </div>

      <div class="form-group">
        <label for="contact_phone">전화번호</label>
        <input type="tel" id="contact_phone" name="contact_phone" value={settings.contact_phone} />
      </div>

      <div class="form-group">
        <label for="contact_address">주소</label>
        <input type="text" id="contact_address" name="contact_address" value={settings.contact_address} />
      </div>
    </div>

    <div class="form-section">
      <h2>서비스 페이지</h2>
      
      <div class="form-group">
        <label for="service_intro">서비스 소개 (상단 텍스트)</label>
        <textarea id="service_intro" name="service_intro" rows="4">{settings.service_intro}</textarea>
        <p class="form-hint">서비스 페이지 상단에 표시되는 소개 문구입니다.</p>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">저장</button>
    </div>
  </form>
</AdminLayout>

<style>
  .admin-header {
    margin-bottom: 2rem;
  }

  .admin-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--c-text);
  }

  .settings-form {
    max-width: 800px;
  }

  .form-section {
    background: white;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .form-section h2 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--c-text);
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #eee;
  }

  .form-group {
    margin-bottom: 1.25rem;
  }

  .form-group:last-child {
    margin-bottom: 0;
  }

  .form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--c-text);
    margin-bottom: 0.5rem;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    transition: border-color 0.2s;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--c-primary, #000);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .form-hint {
    font-size: 0.75rem;
    color: var(--c-text-sub);
    margin-top: 0.5rem;
  }

  .form-actions {
    margin-top: 1.5rem;
  }

  .btn-primary {
    background: var(--c-primary, #000);
    color: white;
    padding: 0.75rem 2rem;
    border: none;
    border-radius: 0.5rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-primary:hover {
    background: #333;
  }

  .btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
</style>

<script>
  const form = document.getElementById('settings-form') as HTMLFormElement;
  
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const data = {
      site_name: formData.get('site_name'),
      site_description: formData.get('site_description'),
      contact_email: formData.get('contact_email'),
      contact_phone: formData.get('contact_phone'),
      contact_address: formData.get('contact_address'),
      service_intro: formData.get('service_intro'),
      // 사업장 정보
      company_name: formData.get('company_name'),
      ceo_name: formData.get('ceo_name'),
      business_number: formData.get('business_number'),
      phone: formData.get('phone'),
      email: formData.get('email'),
      address: formData.get('address'),
      google_maps_url: formData.get('google_maps_url'),
      business_hours: formData.get('business_hours'),
      business_hours_weekend: formData.get('business_hours_weekend'),
      bank_name: formData.get('bank_name'),
      bank_account: formData.get('bank_account'),
      bank_account_holder: formData.get('bank_account_holder')
    };

    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitBtn.disabled = true;
    submitBtn.textContent = '저장 중...';

    try {
      const res = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        alert('설정이 저장되었습니다.');
        window.location.reload();
      } else {
        throw new Error('저장 실패');
      }
    } catch (err) {
      alert('저장에 실패했습니다.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '저장';
    }
  });
</script>
