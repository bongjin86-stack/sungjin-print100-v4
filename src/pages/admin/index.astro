---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { supabase } from '../../lib/supabase';

// ì˜¤ëŠ˜ ë‚ ì§œ (KST ê¸°ì¤€)
const now = new Date();
const kstOffset = 9 * 60 * 60 * 1000;
const kstNow = new Date(now.getTime() + kstOffset);
const todayStart = new Date(kstNow.getFullYear(), kstNow.getMonth(), kstNow.getDate()).toISOString();
const monthStart = new Date(kstNow.getFullYear(), kstNow.getMonth(), 1).toISOString();

// í†µê³„ ë° ì£¼ë¬¸ ë°ì´í„° ë³‘ë ¬ ë¡œë”©
const [
  { count: todayCount },
  { count: pendingCount },
  { count: monthCount },
  { data: recentOrders },
] = await Promise.all([
  // ì˜¤ëŠ˜ ì£¼ë¬¸
  supabase
    .from('orders')
    .select('*', { count: 'exact', head: true })
    .gte('created_at', todayStart),
  // ì²˜ë¦¬ ëŒ€ê¸° (pending, confirmed)
  supabase
    .from('orders')
    .select('*', { count: 'exact', head: true })
    .in('status', ['pending', 'confirmed']),
  // ì´ë²ˆ ë‹¬ ì£¼ë¬¸
  supabase
    .from('orders')
    .select('*', { count: 'exact', head: true })
    .gte('created_at', monthStart),
  // ìµœê·¼ ì£¼ë¬¸ 5ê±´
  supabase
    .from('orders')
    .select('id, order_number, status, customer_email, total_amount, items, created_at')
    .order('created_at', { ascending: false })
    .limit(5),
]);

// ì£¼ë¬¸ ìƒíƒœ í•œê¸€ ë³€í™˜
const statusLabels: Record<string, string> = {
  pending: 'ì…ê¸ˆëŒ€ê¸°',
  confirmed: 'ì…ê¸ˆí™•ì¸',
  in_production: 'ì œì‘ì¤‘',
  shipped: 'ë°°ì†¡ì¤‘',
  completed: 'ì™„ë£Œ',
  canceled: 'ì·¨ì†Œ',
};

const statusColors: Record<string, string> = {
  pending: '#f59e0b',
  confirmed: '#3b82f6',
  in_production: '#8b5cf6',
  shipped: '#06b6d4',
  completed: '#10b981',
  canceled: '#ef4444',
};

// ìƒí’ˆëª… ì¶”ì¶œ
function getProductName(items: any[]): string {
  if (!items || items.length === 0) return '-';
  const first = items[0];
  const name = first.productName || 'ìƒí’ˆ';
  if (items.length > 1) {
    return `${name} ì™¸ ${items.length - 1}ê±´`;
  }
  return name;
}

// ì‹œê°„ í¬ë§·
function formatTime(dateStr: string): string {
  const date = new Date(dateStr);
  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');
  return `${hours}:${minutes}`;
}

// ë‚ ì§œ í¬ë§·
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const month = (date.getMonth() + 1).toString();
  const day = date.getDate().toString();
  return `${month}.${day}`;
}

// ë¹ ë¥¸ ì‘ì—…
const quickActions = [
  { name: 'ê³µì§€ì‚¬í•­ ì‘ì„±', href: '/admin/news/new' },
  { name: 'Works ì¶”ê°€', href: '/admin/works/new' },
  { name: 'ì‚¬ì´íŠ¸ ë³´ê¸°', href: '/', external: true },
];
---

<AdminLayout title="ëŒ€ì‹œë³´ë“œ">
  <div class="dashboard">
    <!-- ì£¼ë¬¸ í˜„í™© ì¹´ë“œ -->
    <div class="stats-section">
      <h2 class="section-title">ğŸ“¦ ì£¼ë¬¸ í˜„í™©</h2>
      <div class="stats-grid">
        <a href="/admin/orders?filter=today" class="stat-card">
          <span class="stat-label">ì˜¤ëŠ˜ ì£¼ë¬¸</span>
          <span class="stat-value">{todayCount || 0}</span>
          <span class="stat-unit">ê±´</span>
        </a>
        <a href="/admin/orders?status=pending,confirmed" class="stat-card highlight">
          <span class="stat-label">ì²˜ë¦¬ ëŒ€ê¸°</span>
          <span class="stat-value">{pendingCount || 0}</span>
          <span class="stat-unit">ê±´</span>
        </a>
        <a href="/admin/orders" class="stat-card">
          <span class="stat-label">ì´ë²ˆ ë‹¬</span>
          <span class="stat-value">{monthCount || 0}</span>
          <span class="stat-unit">ê±´</span>
        </a>
      </div>
    </div>

    <!-- ìµœê·¼ ì£¼ë¬¸ -->
    <div class="dashboard-section">
      <div class="section-header">
        <h2>ìµœê·¼ ì£¼ë¬¸</h2>
        <a href="/admin/orders" class="view-all">ì „ì²´ë³´ê¸° â†’</a>
      </div>
      <div class="orders-list">
        {recentOrders && recentOrders.length > 0 ? (
          recentOrders.map((order) => (
            <a href={`/admin/orders/${order.id}`} class="order-item">
              <span class="order-number">#{order.order_number}</span>
              <span class="order-product">{getProductName(order.items)}</span>
              <span
                class="order-status"
                style={`background-color: ${statusColors[order.status]}20; color: ${statusColors[order.status]}`}
              >
                {statusLabels[order.status] || order.status}
              </span>
              <span class="order-amount">{order.total_amount?.toLocaleString()}ì›</span>
              <span class="order-time">{formatDate(order.created_at)} {formatTime(order.created_at)}</span>
            </a>
          ))
        ) : (
          <div class="empty-state">
            <p>ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        )}
      </div>
    </div>

    <!-- ë¹ ë¥¸ ë§í¬ -->
    <div class="dashboard-section">
      <div class="section-header">
        <h2>ë¹ ë¥¸ ë§í¬</h2>
      </div>
      <div class="quick-actions">
        {quickActions.map((action) => (
          <a
            href={action.href}
            class="action-card"
            target={action.external ? '_blank' : undefined}
          >
            {action.name}
          </a>
        ))}
      </div>
    </div>
  </div>

  <style>
    .dashboard {
      max-width: 1000px;
    }

    .section-title {
      font-size: var(--fs-md);
      font-weight: 600;
      color: var(--c-text);
      margin: 0 0 1rem 0;
    }

    .stats-section {
      margin-bottom: 1.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    @media (max-width: 600px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: var(--c-bg);
      border-radius: 12px;
      padding: 1.5rem;
      text-decoration: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      box-shadow: var(--shadow-base);
      border: 1px solid var(--c-border-light);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .stat-card.highlight {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #f59e0b;
    }

    .stat-label {
      font-size: var(--fs-sm);
      color: var(--c-text-sub);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--c-text);
      line-height: 1;
    }

    .stat-unit {
      font-size: var(--fs-sm);
      color: var(--c-text-sub);
    }

    .dashboard-section {
      background: var(--c-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      box-shadow: var(--shadow-base);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-header h2 {
      margin: 0;
      font-size: var(--fs-md);
      font-weight: 600;
      color: var(--c-text);
    }

    .view-all {
      color: var(--c-primary);
      text-decoration: none;
      font-size: var(--fs-sm);
      font-weight: 500;
    }

    .view-all:hover {
      text-decoration: underline;
    }

    .orders-list {
      display: flex;
      flex-direction: column;
    }

    .order-item {
      display: grid;
      grid-template-columns: 80px 1fr auto 100px 70px;
      align-items: center;
      gap: 1rem;
      padding: 0.875rem 0;
      border-bottom: 1px solid var(--c-border-light);
      text-decoration: none;
      color: var(--c-text);
      transition: background 0.2s;
    }

    @media (max-width: 768px) {
      .order-item {
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
      }

      .order-product,
      .order-amount {
        display: none;
      }
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .order-item:hover {
      background: var(--c-bg-secondary);
      margin: 0 -1rem;
      padding: 0.875rem 1rem;
      border-radius: 8px;
    }

    .order-number {
      font-weight: 600;
      font-size: var(--fs-sm);
      color: var(--c-text);
    }

    .order-product {
      font-size: var(--fs-sm);
      color: var(--c-text-sub);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .order-status {
      font-size: var(--fs-xs);
      font-weight: 500;
      padding: 0.25rem 0.625rem;
      border-radius: 9999px;
      white-space: nowrap;
    }

    .order-amount {
      font-size: var(--fs-sm);
      font-weight: 500;
      text-align: right;
    }

    .order-time {
      font-size: var(--fs-xs);
      color: var(--c-text-light);
      text-align: right;
      white-space: nowrap;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--c-text-sub);
    }

    .empty-state p {
      margin: 0;
      font-size: var(--fs-sm);
    }

    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .action-card {
      padding: 0.75rem 1.25rem;
      background: var(--c-bg-secondary);
      border-radius: 8px;
      text-decoration: none;
      color: var(--c-text);
      font-size: var(--fs-sm);
      font-weight: 500;
      transition: background 0.2s;
    }

    .action-card:hover {
      background: var(--c-border-light);
    }
  </style>
</AdminLayout>
