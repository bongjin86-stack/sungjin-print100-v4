---
import CoverGalleryClient from "@/components/edu100/CoverGallery";
import CTA from "@/components/sections/CTA.astro";
import Layout from "@/layouts/Layout.astro";
import { renderBlocksToHTML } from "@/lib/blockRenderer";
import { supabase } from "@/lib/supabase";

export const prerender = false;

// CDN 캐시: 10분 유지, 24시간 stale-while-revalidate
Astro.response.headers.set(
  "Cache-Control",
  "public, s-maxage=600, stale-while-revalidate=86400"
);

// 섹션 목록 (공개만)
const { data: sections, error: secError } = await supabase
  .from("edu100_sections")
  .select("*")
  .eq("is_published", true)
  .order("sort_order", { ascending: true });

if (secError) {
  console.error("Error fetching edu100 sections:", secError);
}

const sectionList = sections || [];

// gallery 타입 섹션의 커버를 한번에 조회
const gallerySectionIds = sectionList
  .filter((s) => s.type === "gallery")
  .map((s) => s.id);
let allCovers: any[] = [];

if (gallerySectionIds.length > 0) {
  const { data: covers, error: covError } = await supabase
    .from("edu100_covers")
    .select("*")
    .in("section_id", gallerySectionIds)
    .eq("is_published", true)
    .order("sort_order", { ascending: true });

  if (covError) {
    console.error("Error fetching edu100 covers:", covError);
  }
  allCovers = covers || [];
}

// blog 타입 섹션이 있으면 블로그 포스트 조회 (section_id로 배정된 글만)
const blogSectionIds = sectionList
  .filter((s) => s.type === "blog")
  .map((s) => s.id);
let allBlogPosts: any[] = [];

if (blogSectionIds.length > 0) {
  const { data: posts, error: blogError } = await supabase
    .from("blog_posts")
    .select("*")
    .in("section_id", blogSectionIds)
    .eq("is_published", true)
    .order("pub_date", { ascending: false });

  if (blogError) {
    console.error("Error fetching blog posts:", blogError);
  }
  allBlogPosts = posts || [];
}

// 섹션에 데이터 매핑
const sectionsWithData = sectionList.map((section) => ({
  ...section,
  covers:
    section.type === "gallery"
      ? allCovers.filter((c) => c.section_id === section.id)
      : [],
  posts:
    section.type === "blog"
      ? allBlogPosts.filter((p) => p.section_id === section.id)
      : [],
}));

// 모달용 전체 커버 (gallery 섹션만)
const allCoversList = sectionsWithData.flatMap((s) => s.covers || []);
---

<Layout
  title="Edu+100 - 표지 갤러리"
  description="다양한 교재 표지 디자인을 살펴보세요."
>
  <div class="edu100-page">
    {
      sectionsWithData.map((section) => {
        if (section.type === "text") {
          return (
            <div class="edu100-text-section">
              <div
                class="edu100-text-content"
                set:html={renderBlocksToHTML(section.content || "")}
              />
            </div>
          );
        }

        if (section.type === "blog") {
          return (
            <div class="edu100-row-section">
              {section.title && (
                <div class="edu100-section-header">
                  <span class="edu100-section-title">{section.title}</span>
                </div>
              )}
              <div class="edu100-grid-4">
                {section.posts.map((post: any) => (
                  <article class="edu100-card">
                    <a
                      class="edu100-card-link"
                      href={`/blog/${post.slug || post.id}`}
                    >
                      <div class="edu100-card-image">
                        {post.image ? (
                          <img
                            src={post.image}
                            alt={post.title}
                            width="600"
                            height="600"
                            loading="lazy"
                          />
                        ) : (
                          <div class="edu100-card-placeholder">No Image</div>
                        )}
                      </div>
                      <div class="edu100-card-content">
                        <h3 class="edu100-card-title">{post.title}</h3>
                        {post.excerpt && (
                          <p class="edu100-card-subtitle">
                            {post.excerpt.length > 50
                              ? post.excerpt.substring(0, 50) + "..."
                              : post.excerpt}
                          </p>
                        )}
                        <p class="edu100-card-tag">
                          {new Date(post.pub_date).toLocaleDateString("ko-KR")}
                        </p>
                      </div>
                    </a>
                  </article>
                ))}
              </div>
            </div>
          );
        }

        // gallery (6열)
        return (
          <div class="edu100-row-section">
            {section.title && (
              <div class="edu100-section-header">
                <span class="edu100-section-title">{section.title}</span>
              </div>
            )}
            <div class="edu100-grid-6">
              {section.covers.map((cover: any) => (
                <article class="edu100-card">
                  <div
                    class="edu100-card-link"
                    data-cover-id={cover.id}
                    style="cursor:pointer"
                  >
                    <div class="edu100-card-image">
                      {cover.image ? (
                        <img
                          src={cover.image}
                          alt={cover.title}
                          width="600"
                          height="750"
                          loading="lazy"
                        />
                      ) : (
                        <div class="edu100-card-placeholder">No Image</div>
                      )}
                    </div>
                    <div class="edu100-card-content -compact">
                      <div class="edu100-card-row">
                        <h3 class="edu100-card-title">{cover.title}</h3>
                        {cover.tag && (
                          <span class="edu100-card-category">{cover.tag}</span>
                        )}
                        {(cover.design_fee ?? 0) > 0 && (
                          <span class="edu100-card-fee">
                            +{Number(cover.design_fee).toLocaleString()}원
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                </article>
              ))}
            </div>
          </div>
        );
      })
    }

    {
      sectionsWithData.length === 0 && (
        <p class="edu100-empty">등록된 섹션이 없습니다.</p>
      )
    }
  </div>

  <CTA />

  {/* 모달만 React (클릭 이벤트 위임) */}
  <CoverGalleryClient client:only="react" covers={allCoversList} />
</Layout>

<style lang="scss">
  /* ─── 페이지 전체 ─── */
  .edu100-page {
    display: flex;
    flex-direction: column;
    gap: var(--sp-3xl);
    padding-bottom: var(--sp-3xl);
  }

  /* ─── 텍스트 섹션 ─── */
  .edu100-text-section {
    padding: var(--sp-2xl) 16px;

    @media (min-width: 600px) {
      padding: var(--sp-3xl) 16px;
    }
  }

  .edu100-text-content {
    max-width: 960px;
    color: var(--c-text);

    :global(p) {
      font-size: clamp(1.25rem, 2.5vw, 2rem);
      line-height: 1.35;
      font-weight: 400;
      margin-bottom: 0.5em;
    }

    :global(h1),
    :global(h2),
    :global(h3) {
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 0.5em;
    }

    :global(h1) {
      font-size: clamp(1.75rem, 3.5vw, 2.75rem);
    }
    :global(h2) {
      font-size: clamp(1.5rem, 3vw, 2.25rem);
    }
    :global(h3) {
      font-size: clamp(1.25rem, 2.5vw, 1.75rem);
    }

    :global(strong) {
      font-weight: 700;
    }
    :global(em) {
      font-style: italic;
    }
    :global(u) {
      text-decoration: underline;
    }

    :global(ul),
    :global(ol) {
      padding-left: 1.5rem;
      margin-bottom: 0.75em;
      font-size: clamp(1rem, 2vw, 1.5rem);
    }

    :global(li) {
      margin-bottom: 0.25em;
      line-height: 1.5;
    }
  }

  /* ─── 섹션 헤더 (제목) ─── */
  .edu100-section-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 0 12px;
    margin-bottom: 10px;

    @media (min-width: 600px) {
      padding: 0 16px;
    }
  }

  .edu100-section-title {
    font-size: var(--fs-sm);
    font-weight: 500;
    color: var(--c-text);
    letter-spacing: 0.01em;
  }

  /* ─── 4열 그리드 (blog) ─── */
  .edu100-grid-4 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    padding: 0 12px;

    @media (min-width: 600px) {
      padding: 0 16px;
    }

    @media (min-width: 900px) {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  /* ─── 6열 그리드 (gallery) ─── */
  .edu100-grid-6 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4px;
    padding: 0;

    @media (min-width: 600px) {
      grid-template-columns: repeat(3, 1fr);
    }

    @media (min-width: 900px) {
      grid-template-columns: repeat(6, 1fr);
    }
  }

  /* ─── 카드 공통 ─── */
  .edu100-card-link {
    display: block;
  }

  .edu100-card-image {
    position: relative;
    width: 100%;
    overflow: hidden;

    img {
      width: 100%;
      height: auto;
      object-fit: cover;
      aspect-ratio: 1 / 1;
      display: block;
      transition: transform var(--transition-slow);
    }

    .edu100-card:hover & img {
      transform: scale(1.03);
    }
  }

  .edu100-card-placeholder {
    width: 100%;
    aspect-ratio: 1 / 1;
    background-color: var(--c-bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--c-text-sub);
    font-size: var(--fs-xs);
  }

  .edu100-card-content {
    padding: 10px 4px 0;

    &.-compact {
      padding: 6px 4px 0;
    }
  }

  .edu100-card-title {
    color: var(--c-text);
    font-size: var(--fs-xs);
    font-weight: 400;
    line-height: var(--lh-snug);
    flex: 1;
    min-width: 0;

    @media (min-width: 600px) {
      font-size: var(--fs-sm);
    }
  }

  .edu100-card-subtitle {
    color: var(--c-text-sub);
    font-size: var(--fs-xs);
    line-height: var(--lh-snug);
    margin-top: 2px;
  }

  .edu100-card-row {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: var(--sp-xs);
    justify-content: flex-end;
  }

  .edu100-card-category {
    display: inline-block;
    padding: var(--sp-xs) var(--sp-md);
    background-color: var(--c-bg-secondary);
    color: var(--c-text-sub);
    font-size: var(--fs-xs);
    font-weight: 400;
    line-height: var(--lh-tight);
    letter-spacing: 0.02em;
    border-radius: var(--radius-full);
  }

  .edu100-card-fee {
    display: inline-block;
    padding: var(--sp-xs) var(--sp-md);
    background-color: #fef3c7;
    color: #92400e;
    font-size: var(--fs-xs);
    font-weight: 500;
    line-height: var(--lh-tight);
    border-radius: var(--radius-full);
  }

  .edu100-card-tag {
    color: var(--c-text-sub);
    font-size: var(--fs-xs);
    line-height: var(--lh-snug);
    margin-top: 2px;
  }

  .edu100-empty {
    text-align: center;
    color: var(--c-text-sub);
    padding: var(--sp-4xl) 0;
  }

  /* ─── 모달 스타일 (:global — React 컴포넌트용) ─── */
  :global(.edu100-modal-overlay) {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--sp-lg);
  }

  :global(.edu100-modal) {
    background: white;
    border-radius: var(--radius-4xl);
    max-width: 720px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }

  :global(.edu100-modal-image) {
    overflow: hidden;
    border-radius: var(--radius-4xl) var(--radius-4xl) 0 0;

    img {
      width: 100%;
      aspect-ratio: 3 / 2;
      object-fit: cover;
      display: block;
    }
  }

  :global(.edu100-modal-thumbs) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: var(--sp-xs);
    padding: var(--sp-sm) var(--sp-2xl) 0;
  }

  :global(.edu100-modal-thumb) {
    border-radius: var(--radius-lg);
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.15s;
    opacity: 0.6;

    &:hover {
      opacity: 0.9;
    }

    img {
      width: 100%;
      aspect-ratio: 3 / 2;
      object-fit: cover;
      display: block;
    }
  }

  :global(.edu100-modal-thumb.active) {
    border-color: var(--c-primary);
    opacity: 1;
  }

  :global(.edu100-modal-body) {
    padding: var(--sp-xl) var(--sp-2xl) var(--sp-2xl);
  }

  :global(.edu100-modal-title) {
    font-size: var(--fs-2xl);
    font-weight: 700;
    color: var(--c-text);
    margin: 0 0 var(--sp-lg);
    line-height: var(--lh-snug);
  }

  :global(.edu100-modal-desc) {
    font-size: var(--fs-sm);
    color: var(--c-text);
    line-height: var(--lh-relaxed);
    margin: 0 0 var(--sp-xl);

    ul {
      list-style: disc;
      padding-left: 1.25rem;
      margin: var(--sp-sm) 0;
    }

    li {
      margin-bottom: var(--sp-xs);
    }

    p {
      margin-bottom: var(--sp-sm);
    }

    strong,
    b {
      font-weight: 600;
    }
  }

  :global(.edu100-modal-fee) {
    display: inline-block;
    padding: var(--sp-xs) var(--sp-md);
    background-color: #fef3c7;
    color: #92400e;
    font-size: var(--fs-sm);
    font-weight: 500;
    border-radius: var(--radius-lg);
    margin: 0 0 var(--sp-lg);
  }

  :global(.edu100-modal-actions) {
    display: flex;
    gap: var(--sp-sm);
    align-items: center;
  }

  :global(.edu100-order-btn) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--sp-sm) var(--sp-xl);
    background: var(--c-primary);
    color: var(--c-text-inverse);
    border-radius: var(--radius-full);
    text-decoration: none;
    font-weight: 500;
    font-size: var(--fs-sm);
    transition: opacity 0.2s;
    border: none;
    cursor: pointer;

    &:hover {
      opacity: 0.85;
    }
  }

  :global(.edu100-close-btn) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--sp-sm) var(--sp-xl);
    background: var(--c-bg-secondary);
    color: var(--c-text-sub);
    border-radius: var(--radius-full);
    font-weight: 500;
    font-size: var(--fs-sm);
    border: none;
    cursor: pointer;
    transition: background 0.2s;

    &:hover {
      background: var(--c-bg-tertiary, #e5e7eb);
    }
  }
</style>
