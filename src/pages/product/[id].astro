---
import ProductView from "@/components/product/ProductView";
import Layout from "@/layouts/Layout.astro";
import { supabase } from "@/lib/supabase";

import "@/components/product/ProductView.css";

export const prerender = false;

// CDN 캐시: 5분 유지, 24시간 stale-while-revalidate
Astro.response.headers.set(
  "Cache-Control",
  "public, s-maxage=300, stale-while-revalidate=86400"
);

const { id } = Astro.params;

// Supabase에서 상품 데이터 가져오기
const { data: product, error } = await supabase
  .from("products")
  .select("*")
  .eq("id", id)
  .single();

if (error || !product) {
  return Astro.redirect("/404");
}

// content와 blocks가 문자열이면 파싱
function parseJson(val: any, fallback: any) {
  if (!val) return fallback;
  if (typeof val === "object") return val;
  try {
    return JSON.parse(val);
  } catch {
    return fallback;
  }
}

// outsourced_config는 서버에서만 사용 — 클라이언트에 노출하지 않음
const { outsourced_config: _oc, ...safeProduct } = product;
const parsedContent = parseJson(safeProduct.content, {});
const { outsourced_config: _oc2, ...safeContent } = parsedContent;

const productData = {
  ...safeProduct,
  content: safeContent,
  blocks: parseJson(safeProduct.blocks, []),
};

const title = productData.content?.title || productData.name || "상품";
const description =
  productData.content?.description ||
  productData.description ||
  "성진프린트 인쇄 상품";
---

<Layout title={`${title} - 성진프린트`} description={description}>
  <div class="product-page">
    <ProductView client:only="react" product={productData} />
  </div>
</Layout>

<style>
  .product-page {
    padding: var(--sp-2xl) var(--sp-lg) 0;
  }

  @media (min-width: 768px) {
    .product-page {
      padding: var(--sp-3xl) var(--sp-xl) 0;
    }
  }
</style>
