---
import About from "@/components/sections/About.astro";
import CTA from "@/components/sections/CTA.astro";
import Edu100Showcase from "@/components/sections/Edu100Showcase.astro";
import Hero from "@/components/sections/HeroDB.astro";
import News from "@/components/sections/News.astro";
import Partners from "@/components/sections/PartnersDB.astro";
import WorksShowcase from "@/components/sections/WorksShowcase.astro";
import Service from "@/components/sections/Service.astro";
import BlogShowcase from "@/components/sections/BlogShowcase.astro";
import siteConfig from "@/config/site.config.json";
import Layout from "@/layouts/Layout.astro";
import { supabase } from "@/lib/supabase";

export const prerender = false;

// CDN 캐시: 1시간 유지, 24시간 stale-while-revalidate
Astro.response.headers.set(
  "Cache-Control",
  "public, s-maxage=3600, stale-while-revalidate=86400"
);
// 캐시 태그: 어드민 저장 시 Vercel API로 무효화 가능
Astro.response.headers.set("Vercel-Cache-Tag", "landing");

const siteTitle = String(siteConfig.site.title);
const siteDescription = String(siteConfig.site.description);

// 섹션 순서 가져오기
const defaultOrder = [
  "hero",
  "partners",
  "service",
  "products",
  "works",
  "edu100",
  "about",
  "news",
  "cta",
];

let sectionOrder = defaultOrder;
let sectionHidden: string[] = [];
try {
  const { data } = await supabase
    .from("site_settings")
    .select("key, value")
    .in("key", ["landing_section_order", "landing_section_hidden"]);

  if (data) {
    for (const item of data) {
      if (item.key === "landing_section_order" && item.value) {
        const parsed = JSON.parse(item.value);
        if (Array.isArray(parsed) && parsed.length > 0) {
          sectionOrder = parsed;
        }
      }
      if (item.key === "landing_section_hidden" && item.value) {
        const parsed = JSON.parse(item.value);
        if (Array.isArray(parsed)) {
          sectionHidden = parsed;
        }
      }
    }
  }
} catch {
  // 기본 순서 사용
}

// 숨김 섹션 필터링
sectionOrder = sectionOrder.filter((s) => !sectionHidden.includes(s));
---

<Layout title={siteTitle} description={siteDescription}>
  {
    sectionOrder.map((section) => {
      switch (section) {
        case "hero":
          return <Hero />;
        case "partners":
          return <Partners />;
        case "service":
          return <Service />;
        case "products":
          return <WorksShowcase />;
        case "works":
          return <BlogShowcase />;
        case "edu100":
          return <Edu100Showcase />;
        case "about":
          return <About />;
        case "news":
          return <News />;
        case "cta":
          return <CTA />;
        default:
          return null;
      }
    })
  }
</Layout>

<script>
  import Lenis from "lenis";

  let lenis: Lenis | null = null;
  let rafId: number | null = null;

  function initLenis() {
    if (lenis) return;

    lenis = new Lenis({
      duration: 1.0,
      easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      orientation: "vertical",
      wheelMultiplier: 1,
      touchMultiplier: 2,
    });

    function raf(time: number) {
      lenis?.raf(time);
      rafId = requestAnimationFrame(raf);
    }

    rafId = requestAnimationFrame(raf);
  }

  function destroyLenis() {
    if (rafId !== null) {
      cancelAnimationFrame(rafId);
      rafId = null;
    }
    if (lenis) {
      lenis.destroy();
      lenis = null;
    }
  }

  function initializeObserver() {
    const animateElements = document.querySelectorAll("[data-animate]");

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const element = entry.target as HTMLElement;
            const delay = element.dataset.animateDelay || "0";

            setTimeout(() => {
              element.classList.add("is-animated");
            }, parseInt(delay));

            observer.unobserve(element);
          }
        });
      },
      {
        threshold: 0.2,
        rootMargin: "0px 0px -10% 0px",
      }
    );

    animateElements.forEach((element) => {
      observer.observe(element);
    });
  }

  document.addEventListener("astro:page-load", () => {
    if (window.location.pathname === "/") {
      initLenis();
    }
    initializeObserver();
  });

  document.addEventListener("astro:after-swap", () => {
    if (window.location.pathname === "/") {
      initLenis();
    }
    initializeObserver();
  });

  document.addEventListener("astro:before-swap", () => {
    destroyLenis();
  });
</script>
