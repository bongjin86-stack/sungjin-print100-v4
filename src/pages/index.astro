---
import About from "@/components/sections/About.astro";
import CTA from "@/components/sections/CTA.astro";
import Edu100Showcase from "@/components/sections/Edu100Showcase.astro";
import Hero from "@/components/sections/HeroDB.astro";
import News from "@/components/sections/News.astro";
import Partners from "@/components/sections/PartnersDB.astro";
import PrintsShowcase from "@/components/sections/PrintsShowcase.astro";
import Service from "@/components/sections/Service.astro";
import Works from "@/components/sections/WorksDB.astro";
import siteConfig from "@/config/site.config.json";
import Layout from "@/layouts/Layout.astro";

export const prerender = false;

// CDN 캐시: 1시간 유지, 24시간 stale-while-revalidate
Astro.response.headers.set(
  "Cache-Control",
  "public, s-maxage=3600, stale-while-revalidate=86400"
);

const siteTitle = String(siteConfig.site.title);
const siteDescription = String(siteConfig.site.description);
---

<Layout title={siteTitle} description={siteDescription}>
  <Hero />
  <Partners />
  <Service />
  <PrintsShowcase />
  <Works />
  <Edu100Showcase />
  <About />
  <News />
  <CTA />
</Layout>

<script>
  import Lenis from "lenis";

  let lenis: Lenis | null = null;
  let rafId: number | null = null;

  function initLenis() {
    if (lenis) return;

    lenis = new Lenis({
      duration: 1.0,
      easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      orientation: "vertical",
      wheelMultiplier: 1,
      touchMultiplier: 2,
    });

    function raf(time: number) {
      lenis?.raf(time);
      rafId = requestAnimationFrame(raf);
    }

    rafId = requestAnimationFrame(raf);
  }

  function destroyLenis() {
    if (rafId !== null) {
      cancelAnimationFrame(rafId);
      rafId = null;
    }
    if (lenis) {
      lenis.destroy();
      lenis = null;
    }
  }

  function initializeObserver() {
    const animateElements = document.querySelectorAll("[data-animate]");

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const element = entry.target as HTMLElement;
            const delay = element.dataset.animateDelay || "0";

            setTimeout(() => {
              element.classList.add("is-animated");
            }, parseInt(delay));

            observer.unobserve(element);
          }
        });
      },
      {
        threshold: 0.2,
        rootMargin: "0px 0px -10% 0px",
      }
    );

    animateElements.forEach((element) => {
      observer.observe(element);
    });
  }

  document.addEventListener("astro:page-load", () => {
    if (window.location.pathname === "/") {
      initLenis();
    }
    initializeObserver();
  });

  document.addEventListener("astro:after-swap", () => {
    if (window.location.pathname === "/") {
      initLenis();
    }
    initializeObserver();
  });

  document.addEventListener("astro:before-swap", () => {
    destroyLenis();
  });
</script>
