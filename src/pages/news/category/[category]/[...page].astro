---
import Container from "@/components/layout/Container.astro";
import Section from "@/components/layout/Section.astro";
import CTA from "@/components/sections/CTA.astro";
import CategoryNavigation from "@/components/ui/CategoryNavigation.astro";
import PageHero from "@/components/ui/PageHero.astro";
import Pagination from "@/components/ui/Pagination.astro";
import siteConfig from "@/config/site.config.json";
import Layout from "@/layouts/Layout.astro";
import { supabase } from "@/lib/supabase";

// SSR 모드로 전환
export const prerender = false;

// URL에서 카테고리와 페이지 번호 추출
const { category: categoryId, page: pageParam } = Astro.params;
const currentPage = pageParam ? parseInt(pageParam) : 1;
const pageSize = siteConfig.settings.pagination || 9;

// News 카테고리 정의
const categoryList = [
  { id: "information", title: "안내" },
  { id: "event", title: "이벤트" },
  { id: "update", title: "업데이트" }
];

// 현재 카테고리 정보
const category = categoryList.find(c => c.id === categoryId);

// 카테고리가 없으면 404
if (!category) {
  return Astro.redirect('/404');
}

// DB에서 해당 카테고리 News 전체 개수 가져오기
const { count: totalCount } = await supabase
  .from('news')
  .select('*', { count: 'exact', head: true })
  .eq('category', categoryId);

// DB에서 해당 카테고리 News 데이터 가져오기 (페이지네이션)
const { data: newsList, error: newsError } = await supabase
  .from('news')
  .select('*')
  .eq('category', categoryId)
  .order('pub_date', { ascending: false })
  .range((currentPage - 1) * pageSize, currentPage * pageSize - 1);

if (newsError) {
  console.error('Error fetching news:', newsError);
}

const newsData = newsList || [];
const totalPages = Math.ceil((totalCount || 0) / pageSize);

const pageTitle =
  currentPage === 1
    ? `News - ${category.title}`
    : `News - ${category.title} (${currentPage}페이지)`;

// 카테고리 ID로 카테고리 제목 찾기
function getCategoryTitle(catId: string): string {
  const cat = categoryList.find(c => c.id === catId);
  return cat?.title || catId;
}

// 날짜 포맷팅
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return date.toLocaleDateString("ko-KR", {
    year: "numeric",
    month: "numeric",
    day: "numeric",
  }).replace(/\//g, ".");
}
---

<Layout
  title={pageTitle}
  description={`${category.title} 카테고리의 공지사항을 안내합니다.`}
>
  <PageHero title="News" subtitle={category.title} />

  <Section class="news-section">
    <Container>
      <CategoryNavigation
        categories={categoryList}
        currentCategory={category.id}
        basePath="/news"
      />

      <div class="news-list">
        {newsData.map((news) => (
          <article class="news-item">
            <a href={`/news/${news.id}`} class="news-link">
              <time class="news-date" datetime={news.pub_date}>
                {formatDate(news.pub_date)}
              </time>
              <span class="news-category">{getCategoryTitle(news.category)}</span>
              <h3 class="news-item-title">{news.title}</h3>
            </a>
          </article>
        ))}
      </div>

      {totalPages > 1 && (
        <Pagination
          currentPage={currentPage}
          totalPages={totalPages}
          basePath={`/news/category/${category.id}`}
        />
      )}
    </Container>
  </Section>

  <CTA />
</Layout>

<style lang="scss">
  .news-section {
    padding-top: var(--sp-md);
  }

  .news-list {
    display: flex;
    flex-direction: column;
    gap: var(--sp-xl);
    width: 100%;
    margin-top: var(--sp-3xl);

    @media (min-width: 600px) {
      gap: var(--sp-md);
    }
  }

  .news-link {
    display: grid;
    grid-template-columns: 88px 1fr;
    grid-template-rows: auto auto;
    align-items: center;
    gap: var(--sp-sm) var(--sp-xs);
    color: var(--c-text);
    text-decoration: none;

    @media (min-width: 600px) {
      grid-template-columns: 88px 120px 1fr;
      grid-template-rows: auto;
      gap: 0 var(--sp-sm);
    }
  }

  .news-date {
    grid-column: 1 / 2;
    grid-row: 1 / 2;
    color: var(--c-text-sub);
    font-size: var(--fs-sm);
    align-self: center;

    @media (min-width: 600px) {
      grid-column: 1 / 2;
      font-size: var(--fs-base);
    }
  }

  .news-category {
    grid-column: 2 / 3;
    grid-row: 1 / 2;
    width: fit-content;
    padding: var(--sp-xs) var(--sp-sm);
    background-color: var(--c-bg-secondary);
    color: var(--c-text);
    font-size: var(--fs-xs);
    line-height: var(--lh-none);
    text-transform: uppercase;
    border-radius: var(--radius-md);

    @media (min-width: 600px) {
      grid-column: 2 / 3;
    }
  }

  .news-item-title {
    grid-column: 1 / 3;
    grid-row: 2 / 3;
    color: var(--c-text);
    font-size: var(--fs-sm);
    line-height: var(--lh-relaxed);

    @media (min-width: 600px) {
      grid-column: 3 / -1;
      grid-row: 1 / 2;
    }

    @media (min-width: 900px) {
      font-size: var(--fs-base);
    }

    .news-link:hover & {
      text-decoration: underline;
      text-underline-offset: 4px;
    }
  }
</style>
