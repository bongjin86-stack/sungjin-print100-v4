---
import Container from "@/components/layout/Container.astro";
import Section from "@/components/layout/Section.astro";
import CTA from "@/components/sections/CTA.astro";
import CategoryNavigation from "@/components/ui/CategoryNavigation.astro";
import PageHero from "@/components/ui/PageHero.astro";
import Pagination from "@/components/ui/Pagination.astro";
import siteConfig from "@/config/site.config.json";
import Layout from "@/layouts/Layout.astro";
import { supabase } from "@/lib/supabase";

// SSR 모드로 전환
export const prerender = false;

// URL에서 페이지 번호 추출
const { page: pageParam } = Astro.params;
const currentPage = pageParam ? parseInt(pageParam) : 1;
const pageSize = siteConfig.settings.pagination || 9;

// DB에서 카테고리 데이터 가져오기
const { data: categories, error: catError } = await supabase
  .from("work_categories")
  .select("*")
  .order("sort_order", { ascending: true });

if (catError) {
  console.error("Error fetching categories:", catError);
}

// 카테고리 데이터를 CategoryNavigation 형식으로 변환
const categoryList =
  categories?.map((cat) => ({
    id: cat.id,
    title: cat.title,
  })) || [];

// DB에서 Works 전체 개수 가져오기
const { count: totalCount } = await supabase
  .from("works")
  .select("*", { count: "exact", head: true })
  .eq("is_published", true);

// DB에서 Works 데이터 가져오기 (페이지네이션)
const { data: works, error: worksError } = await supabase
  .from("works")
  .select("*")
  .eq("is_published", true)
  .order("sort_order", { ascending: true })
  .range((currentPage - 1) * pageSize, currentPage * pageSize - 1);

if (worksError) {
  console.error("Error fetching works:", worksError);
}

const worksList = works || [];
const totalPages = Math.ceil((totalCount || 0) / pageSize);

const pageTitle =
  currentPage === 1
    ? "Works - 제작실적"
    : `Works - 제작실적 (${currentPage}페이지)`;

// 카테고리 ID로 카테고리 제목 찾기
function getCategoryTitle(categoryId: string): string {
  const cat = categoryList.find((c) => c.id === categoryId);
  return cat?.title || categoryId;
}
---

<Layout
  title={pageTitle}
  description="인쇄에 필요한 다양한 가이드와 작업 사례를 소개합니다."
>
  <PageHero title="Works" subtitle="제작실적" />

  <Section class="works-section">
    <Container>
      <CategoryNavigation categories={categoryList} basePath="/works" />

      <div class="works-grid">
        {
          worksList.map((work) => (
            <article class="work-card">
              <a href={`/works/${work.id}`} class="work-card-link">
                <div class="work-card-image">
                  {work.image ? (
                    <img
                      src={work.image}
                      alt={work.title}
                      width="600"
                      height="400"
                      loading="lazy"
                    />
                  ) : (
                    <div class="work-card-placeholder">No Image</div>
                  )}
                </div>
                <div class="work-card-content">
                  <h3 class="work-card-title">{work.title}</h3>
                  <p class="work-card-client">{work.client || work.subtitle}</p>
                  <span class="work-card-category">
                    {getCategoryTitle(work.category_id)}
                  </span>
                </div>
              </a>
            </article>
          ))
        }
      </div>

      {
        totalPages > 1 && (
          <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            basePath="/works"
          />
        )
      }
    </Container>
  </Section>

  <CTA />
</Layout>

<style lang="scss">
  .works-section {
    padding-top: var(--sp-md);
  }

  .works-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--sp-2xl);
    margin-top: var(--sp-3xl);

    @media (min-width: 600px) {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--sp-xl);
    }

    @media (min-width: 900px) {
      grid-template-columns: repeat(3, 1fr);
      gap: var(--sp-2xl);
    }
  }

  .work-card-link {
    display: block;
  }

  .work-card-image {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: var(--radius-4xl);

    img {
      width: 100%;
      height: auto;
      object-fit: cover;
      aspect-ratio: 3 / 2;
      transition: transform var(--transition-slow);
    }

    .work-card:hover & img {
      transform: scale(1.05);
    }
  }

  .work-card-placeholder {
    width: 100%;
    aspect-ratio: 3 / 2;
    background-color: var(--c-bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--c-text-sub);
  }

  .work-card-content {
    display: flex;
    flex-direction: column;
    gap: var(--sp-xs);
    margin: var(--sp-md) 0 0;
  }

  .work-card-title {
    color: var(--c-text);
    font-size: var(--fs-md);
    font-weight: 500;
    line-height: var(--lh-snug);

    @media (min-width: 600px) {
      font-size: var(--fs-lg);
    }
  }

  .work-card-client {
    color: var(--c-text-sub);
    font-size: var(--fs-sm);
    line-height: var(--lh-snug);
  }

  .work-card-category {
    display: inline-block;
    align-self: self-start;
    margin-top: var(--sp-xs);
    padding: var(--sp-xs) var(--sp-md);
    background-color: var(--c-bg-secondary);
    color: var(--c-text-sub);
    font-size: var(--fs-xs);
    font-weight: 400;
    line-height: var(--lh-tight);
    text-transform: uppercase;
    letter-spacing: 0.02em;
    border-radius: var(--radius-full);
  }
</style>
