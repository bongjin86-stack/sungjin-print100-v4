---
import Container from "@/components/layout/Container.astro";
import Section from "@/components/layout/Section.astro";
import Layout from "@/layouts/Layout.astro";
import { supabase } from "../../../lib/supabase";
import { marked } from "marked";

export const prerender = false;

const { id } = Astro.params;

// DB에서 work 가져오기
const { data: work, error } = await supabase
  .from('works')
  .select('*')
  .eq('id', id)
  .single();

if (error || !work) {
  return Astro.redirect('/works');
}

// 마크다운을 HTML로 변환
const contentHtml = work.content ? marked(work.content) : '';
---

<Layout title={`${work.title} | Sungjinprint`} description={work.description}>
  <Section background="primary">
    <Container>
      <article class="work-detail">
        <header class="work-header">
          <span class="work-tag">{work.tag || '가이드'}</span>
          <h1 class="work-title">{work.title}</h1>
          <p class="work-description">{work.description}</p>
        </header>

        {work.image && (
          <div class="work-image">
            <img src={work.image} alt={work.title} />
          </div>
        )}

        <div class="work-content" set:html={contentHtml} />

        <footer class="work-footer">
          <a href="/works" class="back-link">목록으로 돌아가기</a>
        </footer>
      </article>
    </Container>
  </Section>
</Layout>

<style lang="scss">
  .work-detail {
    max-width: 800px;
    margin: 0 auto;
  }

  .work-header {
    text-align: center;
    margin-bottom: var(--sp-4xl);
  }

  .work-tag {
    display: inline-block;
    padding: var(--sp-xs) var(--sp-md);
    background: var(--c-primary);
    color: var(--c-text-inverse);
    font-size: var(--fs-xs);
    font-weight: 500;
    border-radius: var(--radius-full);
    margin-bottom: var(--sp-lg);
  }

  .work-title {
    font-size: var(--fs-3xl);
    font-weight: 600;
    color: var(--c-text);
    margin-bottom: var(--sp-md);

    @media (min-width: 900px) {
      font-size: var(--fs-4xl);
    }
  }

  .work-description {
    font-size: var(--fs-lg);
    color: var(--c-text-sub);
    line-height: var(--lh-loose);
  }

  .work-image {
    margin-bottom: var(--sp-4xl);
    border-radius: var(--radius-3xl);
    overflow: hidden;

    img {
      width: 100%;
      height: auto;
      object-fit: cover;
    }
  }

  .work-content {
    font-size: var(--fs-base);
    line-height: var(--lh-loose);
    color: var(--c-text);

    :global(h2) {
      font-size: var(--fs-2xl);
      font-weight: 600;
      margin: var(--sp-4xl) 0 var(--sp-lg);
      color: var(--c-text);
    }

    :global(h3) {
      font-size: var(--fs-xl);
      font-weight: 600;
      margin: var(--sp-3xl) 0 var(--sp-md);
      color: var(--c-text);
    }

    :global(p) {
      margin-bottom: var(--sp-lg);
    }

    :global(ul), :global(ol) {
      margin: var(--sp-lg) 0;
      padding-left: var(--sp-xl);
    }

    :global(li) {
      margin-bottom: var(--sp-sm);
    }

    :global(strong) {
      font-weight: 600;
    }

    :global(blockquote) {
      border-left: 4px solid var(--c-primary);
      padding-left: var(--sp-lg);
      margin: var(--sp-xl) 0;
      color: var(--c-text-sub);
      font-style: italic;
    }
  }

  .work-footer {
    margin-top: var(--sp-5xl);
    padding-top: var(--sp-xl);
    border-top: 1px solid var(--c-border);
    text-align: center;
  }

  .back-link {
    display: inline-block;
    padding: var(--sp-md) var(--sp-xl);
    border: 1px solid var(--c-border);
    border-radius: var(--radius-full);
    color: var(--c-text);
    font-size: var(--fs-sm);
    transition: all var(--transition-slow);

    &:hover {
      background: var(--c-primary);
      color: var(--c-text-inverse);
      border-color: var(--c-primary);
    }
  }
</style>
