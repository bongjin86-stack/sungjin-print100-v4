---
import Container from "@/components/layout/Container.astro";
import Section from "@/components/layout/Section.astro";
import CTA from "@/components/sections/CTA.astro";
import LinkButton from "@/components/ui/LinkButton.astro";
import PageHero from "@/components/ui/PageHero.astro";
import Layout from "@/layouts/Layout.astro";
import { renderBlocksToHTML } from "@/lib/blockRenderer";
import { supabase } from "@/lib/supabase";

// SSR 모드로 전환
export const prerender = false;

// URL에서 ID 추출
const { id } = Astro.params;

// DB에서 Work 데이터 가져오기
const { data: work, error: workError } = await supabase
  .from("works")
  .select("*")
  .eq("id", id)
  .single();

if (workError || !work) {
  return Astro.redirect("/404");
}

// DB에서 카테고리 데이터 가져오기
const { data: category } = await supabase
  .from("work_categories")
  .select("title")
  .eq("id", work.category_id)
  .single();

const categoryTitle = category?.title || work.category_id || "";

// support와 achievements JSON 파싱
let supportList: string[] = [];
let achievementsList: { title: string; description: string }[] = [];
let testimonial: { text: string; author: string; position: string } | null =
  null;

try {
  if (work.support) {
    supportList =
      typeof work.support === "string"
        ? JSON.parse(work.support)
        : work.support;
  }
} catch (e) {
  supportList = [];
}

try {
  if (work.achievements) {
    achievementsList =
      typeof work.achievements === "string"
        ? JSON.parse(work.achievements)
        : work.achievements;
  }
} catch (e) {
  achievementsList = [];
}

try {
  if (work.testimonial) {
    testimonial =
      typeof work.testimonial === "string"
        ? JSON.parse(work.testimonial)
        : work.testimonial;
  }
} catch (e) {
  testimonial = null;
}

const ogImageUrl = work.image || "";

// BlockNote JSON 또는 마크다운을 HTML로 변환
const contentHtml = work.content ? renderBlocksToHTML(work.content) : "";
---

<Layout
  title={`${work.title} - Works`}
  description={work.description || work.overview || ""}
  ogImage={ogImageUrl}
>
  <PageHero title={work.title} subtitle={work.subtitle || ""} />

  <Section>
    <Container size="medium">
      <div class="work-detail-image">
        {
          work.image ? (
            <img
              src={work.image}
              alt={work.title}
              width="1200"
              height="675"
              loading="eager"
            />
          ) : (
            <div class="work-image-placeholder">No Image</div>
          )
        }
      </div>

      <div class="work-detail-meta">
        <div class="meta-item">
          <dt class="meta-label">분류</dt>
          <dd class="meta-value">{work.client || ""}</dd>
        </div>
        <div class="meta-item">
          <dt class="meta-label">카테고리</dt>
          <dd class="meta-value">{categoryTitle}</dd>
        </div>
        <div class="meta-item">
          <dt class="meta-label">연도</dt>
          <dd class="meta-value">{work.year || new Date().getFullYear()}</dd>
        </div>
      </div>

      <div class="work-content">
        {
          work.overview && (
            <div class="work-section">
              <h2 class="work-section-title">개요</h2>
              <p class="work-section-text">{work.overview}</p>
            </div>
          )
        }

        {
          supportList.length > 0 && (
            <div class="work-section">
              <h2 class="work-section-title">주요 내용</h2>
              <ul class="work-support-list">
                {supportList.map((item) => (
                  <li class="support-item">{item}</li>
                ))}
              </ul>
            </div>
          )
        }

        {
          achievementsList.length > 0 && (
            <div class="work-section">
              <h2 class="work-section-title">상세 정보</h2>
              <div class="work-achievements">
                {achievementsList.map((achievement) => (
                  <div class="achievement-item">
                    <h3 class="achievement-title">{achievement.title}</h3>
                    <p class="achievement-description">
                      {achievement.description}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          )
        }

        {
          testimonial && (
            <div class="work-section work-testimonial">
              <h2 class="work-section-title">고객 후기</h2>
              <blockquote class="testimonial-quote">
                <p class="testimonial-text">{testimonial.text}</p>
                <footer class="testimonial-author">
                  <cite class="author-name">{testimonial.author}</cite>
                  <span class="author-position">{testimonial.position}</span>
                </footer>
              </blockquote>
            </div>
          )
        }

        {
          work.content && (
            <div class="work-section">
              <h2 class="work-section-title">상세 내용</h2>
              <div class="work-section-text" set:html={contentHtml} />
            </div>
          )
        }
      </div>

      <div class="work-action">
        <LinkButton
          href="/works"
          variant="solid"
          size="large"
          class="work-action-button"
        >
          목록으로 돌아가기
        </LinkButton>
      </div>
    </Container>
  </Section>

  <CTA />
</Layout>

<style lang="scss">
  .work-detail-image {
    width: 100%;
    overflow: hidden;
    border-radius: var(--radius-6xl);
    margin: 0 0 var(--sp-xl);

    img {
      width: 100%;
      height: auto;
      object-fit: cover;
      aspect-ratio: 16 / 9;
    }
  }

  .work-image-placeholder {
    width: 100%;
    aspect-ratio: 16 / 9;
    background-color: var(--c-bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--c-text-sub);
    font-size: var(--fs-lg);
  }

  .work-detail-meta {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--sp-lg);
    margin: var(--sp-xl) 0 var(--sp-3xl);
    padding: var(--sp-xl);
    background-color: var(--c-bg-secondary);
    border-radius: var(--radius-4xl);

    @media (min-width: 600px) {
      grid-template-columns: repeat(3, 1fr);
      gap: var(--sp-2xl);
      margin: var(--sp-xl) 0 var(--sp-4xl);
    }
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: var(--sp-xs);
  }

  .meta-label {
    color: var(--c-text-sub);
    font-size: var(--fs-xs);
    font-weight: 500;
    line-height: var(--lh-tight);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .meta-value {
    color: var(--c-text);
    font-size: var(--fs-base);
    font-weight: 400;
    line-height: var(--lh-normal);

    @media (min-width: 900px) {
      font-size: var(--fs-md);
    }
  }

  .work-content {
    display: flex;
    flex-direction: column;
    gap: var(--sp-3xl);

    @media (min-width: 900px) {
      gap: var(--sp-4xl);
    }
  }

  .work-section {
    display: flex;
    flex-direction: column;
    gap: var(--sp-lg);

    @media (min-width: 900px) {
      gap: var(--sp-xl);
    }
  }

  .work-section-title {
    color: var(--c-text);
    font-size: var(--fs-xl);
    font-weight: 500;
    line-height: var(--lh-tight);

    @media (min-width: 900px) {
      font-size: var(--fs-2xl);
    }
  }

  .work-section-text {
    color: var(--c-text);
    font-size: var(--fs-base);
    line-height: var(--lh-loose);

    @media (min-width: 900px) {
      font-size: var(--fs-md);
    }
  }

  .work-support-list {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--sp-sm);

    @media (min-width: 600px) {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .support-item {
    position: relative;
    padding-left: var(--sp-lg);
    color: var(--c-text);
    font-size: var(--fs-base);
    line-height: var(--lh-relaxed);

    &::before {
      content: "・";
      position: absolute;
      left: 0;
      color: var(--c-primary);
      font-weight: 600;
    }

    @media (min-width: 900px) {
      font-size: var(--fs-md);
    }
  }

  .work-achievements {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--sp-xl);

    @media (min-width: 600px) {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--sp-xl);
    }
  }

  .achievement-item {
    display: flex;
    flex-direction: column;
    gap: var(--sp-sm);
    padding: var(--sp-lg);
    background-color: var(--c-bg-secondary);
    border-radius: var(--radius-3xl);
  }

  .achievement-title {
    color: var(--c-text);
    font-size: var(--fs-md);
    font-weight: 500;
    line-height: var(--lh-snug);

    @media (min-width: 900px) {
      font-size: var(--fs-lg);
    }
  }

  .achievement-description {
    color: var(--c-text-sub);
    font-size: var(--fs-sm);
    line-height: var(--lh-relaxed);

    @media (min-width: 900px) {
      font-size: var(--fs-base);
    }
  }

  .work-testimonial {
    padding: var(--sp-xl);
    border: 1px solid var(--c-border);
    border-radius: var(--radius-4xl);

    @media (min-width: 900px) {
      padding: var(--sp-2xl);
    }
  }

  .testimonial-quote {
    display: flex;
    flex-direction: column;
    gap: var(--sp-lg);
  }

  .testimonial-text {
    color: var(--c-text);
    font-size: var(--fs-base);
    line-height: var(--lh-relaxed);
    font-style: italic;

    @media (min-width: 900px) {
      font-size: var(--fs-md);
    }
  }

  .testimonial-author {
    display: flex;
    flex-direction: column;
    gap: var(--sp-2xs);
  }

  .author-name {
    color: var(--c-text);
    font-size: var(--fs-base);
    font-weight: 500;
    font-style: normal;
  }

  .author-position {
    color: var(--c-text-sub);
    font-size: var(--fs-sm);
    line-height: var(--lh-normal);
  }

  .work-action {
    display: flex;
    justify-content: center;
    margin: var(--sp-2xl) 0 0;
  }
</style>
