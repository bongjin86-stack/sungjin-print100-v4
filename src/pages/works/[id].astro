---
import Container from "@/components/layout/Container.astro";
import Section from "@/components/layout/Section.astro";
import CTA from "@/components/sections/CTA.astro";
import LinkButton from "@/components/ui/LinkButton.astro";
import PageHero from "@/components/ui/PageHero.astro";
import Layout from "@/layouts/Layout.astro";
import { renderBlocksToHTML } from "@/lib/blockRenderer";
import { supabase } from "@/lib/supabase";

// SSR 모드로 전환
export const prerender = false;

// CDN 캐시: 10분 유지, 24시간 stale-while-revalidate
Astro.response.headers.set(
  "Cache-Control",
  "public, s-maxage=600, stale-while-revalidate=86400"
);

// URL에서 ID 추출
const { id } = Astro.params;

// DB에서 Print 데이터 가져오기
const { data: print, error: printError } = await supabase
  .from("prints")
  .select("*")
  .eq("id", id)
  .single();

if (printError || !print) {
  return Astro.redirect("/404");
}

// 바로 이동 설정: 상세 페이지 없이 상품 페이지로 리다이렉트
if (print.redirect_to_product && print.linked_product_id) {
  return Astro.redirect(`/product/${print.linked_product_id}`);
}

const categoryTitle = print.tag || "";

// field_labels 파싱 (커스텀 라벨)
let labels = {
  meta1_label: "분류",
  meta2_label: "카테고리",
  meta3_label: "연도",
  overview_label: "개요",
  support_label: "주요 내용",
  achievements_label: "상세 정보",
  content_label: "상세 내용",
};

try {
  if (print.field_labels) {
    const parsed =
      typeof print.field_labels === "string"
        ? JSON.parse(print.field_labels)
        : print.field_labels;
    labels = { ...labels, ...parsed };
  }
} catch (e) {
  // 기본 라벨 사용
}

// support와 achievements JSON 파싱
let supportList: string[] = [];
let achievementsList: { title: string; description: string }[] = [];
let testimonial: { text: string; author: string; position: string } | null =
  null;

try {
  if (print.support) {
    supportList =
      typeof print.support === "string"
        ? JSON.parse(print.support)
        : print.support;
  }
} catch (e) {
  supportList = [];
}

try {
  if (print.achievements) {
    achievementsList =
      typeof print.achievements === "string"
        ? JSON.parse(print.achievements)
        : print.achievements;
  }
} catch (e) {
  achievementsList = [];
}

try {
  if (print.testimonial) {
    testimonial =
      typeof print.testimonial === "string"
        ? JSON.parse(print.testimonial)
        : print.testimonial;
  }
} catch (e) {
  testimonial = null;
}

const ogImageUrl = print.image || "";

// BlockNote JSON 또는 마크다운을 HTML로 변환
const contentHtml = print.content ? renderBlocksToHTML(print.content) : "";

// 주문하기 버튼 관련
const hasLinkedProduct = !!print.linked_product_id;
const orderButtonText = print.order_button_text || "주문하기";
const orderHref = hasLinkedProduct
  ? `/product/${print.linked_product_id}`
  : null;
---

<Layout
  title={`${print.title} - Prints`}
  description={print.description || print.overview || ""}
  ogImage={ogImageUrl}
>
  <PageHero title={print.title} subtitle={print.subtitle || ""} />

  <Section>
    <Container size="medium">
      <div class="print-detail-image">
        {
          print.image ? (
            <img
              src={print.image}
              alt={print.title}
              width="1200"
              height="675"
              loading="eager"
            />
          ) : (
            <div class="print-image-placeholder">No Image</div>
          )
        }
      </div>

      <div class="print-detail-meta">
        <div class="meta-item">
          <dt class="meta-label">{labels.meta1_label}</dt>
          <dd class="meta-value">{print.client || ""}</dd>
        </div>
        <div class="meta-item">
          <dt class="meta-label">{labels.meta2_label}</dt>
          <dd class="meta-value">{categoryTitle}</dd>
        </div>
        <div class="meta-item">
          <dt class="meta-label">{labels.meta3_label}</dt>
          <dd class="meta-value">{print.year || new Date().getFullYear()}</dd>
        </div>
      </div>

      <div class="print-content">
        {
          print.overview && (
            <div class="print-section">
              <h2 class="print-section-title">{labels.overview_label}</h2>
              <p class="print-section-text">{print.overview}</p>
            </div>
          )
        }

        {
          supportList.length > 0 && (
            <div class="print-section">
              <h2 class="print-section-title">{labels.support_label}</h2>
              <ul class="print-support-list">
                {supportList.map((item) => (
                  <li class="support-item">{item}</li>
                ))}
              </ul>
            </div>
          )
        }

        {
          achievementsList.length > 0 && (
            <div class="print-section">
              <h2 class="print-section-title">{labels.achievements_label}</h2>
              <div class="print-achievements">
                {achievementsList.map((achievement) => (
                  <div class="achievement-item">
                    <h3 class="achievement-title">{achievement.title}</h3>
                    <p class="achievement-description">
                      {achievement.description}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          )
        }

        {
          testimonial && (
            <div class="print-section print-testimonial">
              <h2 class="print-section-title">고객 후기</h2>
              <blockquote class="testimonial-quote">
                <p class="testimonial-text">{testimonial.text}</p>
                <footer class="testimonial-author">
                  <cite class="author-name">{testimonial.author}</cite>
                  <span class="author-position">{testimonial.position}</span>
                </footer>
              </blockquote>
            </div>
          )
        }

        {
          print.content && (
            <div class="print-section">
              <h2 class="print-section-title">{labels.content_label}</h2>
              <div class="print-section-text" set:html={contentHtml} />
            </div>
          )
        }
      </div>

      <div class="print-action">
        {
          orderHref ? (
            <LinkButton
              href={orderHref}
              variant="solid"
              size="large"
              class="print-action-button"
            >
              {orderButtonText}
            </LinkButton>
          ) : (
            <LinkButton
              href="/works"
              variant="solid"
              size="large"
              class="print-action-button"
            >
              목록으로 돌아가기
            </LinkButton>
          )
        }
        {
          orderHref && (
            <LinkButton
              href="/works"
              variant="outline"
              size="large"
              class="print-action-button-sub"
            >
              목록으로 돌아가기
            </LinkButton>
          )
        }
      </div>
    </Container>
  </Section>

  <CTA />
</Layout>

<style lang="scss">
  .print-detail-image {
    width: 100%;
    overflow: hidden;
    border-radius: var(--radius-6xl);
    margin: 0 0 var(--sp-xl);

    img {
      width: 100%;
      height: auto;
      object-fit: cover;
      aspect-ratio: 16 / 9;
    }
  }

  .print-image-placeholder {
    width: 100%;
    aspect-ratio: 16 / 9;
    background-color: var(--c-bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--c-text-sub);
    font-size: var(--fs-lg);
  }

  .print-detail-meta {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--sp-lg);
    margin: var(--sp-xl) 0 var(--sp-3xl);
    padding: var(--sp-xl);
    background-color: var(--c-bg-secondary);
    border-radius: var(--radius-4xl);

    @media (min-width: 600px) {
      grid-template-columns: repeat(3, 1fr);
      gap: var(--sp-2xl);
      margin: var(--sp-xl) 0 var(--sp-4xl);
    }
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: var(--sp-xs);
  }

  .meta-label {
    color: var(--c-text-sub);
    font-size: var(--fs-xs);
    font-weight: 500;
    line-height: var(--lh-tight);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .meta-value {
    color: var(--c-text);
    font-size: var(--fs-base);
    font-weight: 400;
    line-height: var(--lh-normal);

    @media (min-width: 900px) {
      font-size: var(--fs-md);
    }
  }

  .print-content {
    display: flex;
    flex-direction: column;
    gap: var(--sp-3xl);

    @media (min-width: 900px) {
      gap: var(--sp-4xl);
    }
  }

  .print-section {
    display: flex;
    flex-direction: column;
    gap: var(--sp-lg);

    @media (min-width: 900px) {
      gap: var(--sp-xl);
    }
  }

  .print-section-title {
    color: var(--c-text);
    font-size: var(--fs-xl);
    font-weight: 500;
    line-height: var(--lh-tight);

    @media (min-width: 900px) {
      font-size: var(--fs-2xl);
    }
  }

  .print-section-text {
    color: var(--c-text);
    font-size: var(--fs-base);
    line-height: var(--lh-loose);

    @media (min-width: 900px) {
      font-size: var(--fs-md);
    }
  }

  .print-support-list {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--sp-sm);

    @media (min-width: 600px) {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .support-item {
    position: relative;
    padding-left: var(--sp-lg);
    color: var(--c-text);
    font-size: var(--fs-base);
    line-height: var(--lh-relaxed);

    &::before {
      content: "・";
      position: absolute;
      left: 0;
      color: var(--c-primary);
      font-weight: 600;
    }

    @media (min-width: 900px) {
      font-size: var(--fs-md);
    }
  }

  .print-achievements {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--sp-xl);

    @media (min-width: 600px) {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--sp-xl);
    }
  }

  .achievement-item {
    display: flex;
    flex-direction: column;
    gap: var(--sp-sm);
    padding: var(--sp-lg);
    background-color: var(--c-bg-secondary);
    border-radius: var(--radius-3xl);
  }

  .achievement-title {
    color: var(--c-text);
    font-size: var(--fs-md);
    font-weight: 500;
    line-height: var(--lh-snug);

    @media (min-width: 900px) {
      font-size: var(--fs-lg);
    }
  }

  .achievement-description {
    color: var(--c-text-sub);
    font-size: var(--fs-sm);
    line-height: var(--lh-relaxed);

    @media (min-width: 900px) {
      font-size: var(--fs-base);
    }
  }

  .print-testimonial {
    padding: var(--sp-xl);
    border: 1px solid var(--c-border);
    border-radius: var(--radius-4xl);

    @media (min-width: 900px) {
      padding: var(--sp-2xl);
    }
  }

  .testimonial-quote {
    display: flex;
    flex-direction: column;
    gap: var(--sp-lg);
  }

  .testimonial-text {
    color: var(--c-text);
    font-size: var(--fs-base);
    line-height: var(--lh-relaxed);
    font-style: italic;

    @media (min-width: 900px) {
      font-size: var(--fs-md);
    }
  }

  .testimonial-author {
    display: flex;
    flex-direction: column;
    gap: var(--sp-2xs);
  }

  .author-name {
    color: var(--c-text);
    font-size: var(--fs-base);
    font-weight: 500;
    font-style: normal;
  }

  .author-position {
    color: var(--c-text-sub);
    font-size: var(--fs-sm);
    line-height: var(--lh-normal);
  }

  .print-action {
    display: flex;
    justify-content: center;
    gap: var(--sp-md);
    margin: var(--sp-2xl) 0 0;
  }
</style>
